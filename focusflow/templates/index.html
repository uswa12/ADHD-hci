<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow - ADHD Study Assistant</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=OpenDyslexic&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        #focus-chart {
            height: 350px !important;
            width: 100% !important;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: white;
            padding: 24px;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: #5ec4a9;
            margin-bottom: 40px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6e6e73;
            transition: all 0.3s;
        }

        .nav-item:hover {
            background: #f5f5f7;
            color: #1d1d1f;
        }

        .nav-item.active {
            background: #e8f5f2;
            color: #5ec4a9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .header p {
            color: #6e6e73;
            font-size: 16px;
        }

        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #e8f5f2;
            color: #5ec4a9;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 16px;
        }

        /* Dashboard Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Focus Status */
        .focus-status {
            margin-bottom: 24px;
        }

        .focus-status h3 {
            font-size: 14px;
            color: #6e6e73;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .focus-meter {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .focus-meter span {
            font-size: 32px;
            font-weight: 600;
        }

        .progress-bar {
            flex: 1;
            height: 12px;
            background: #e8e8ed;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5ec4a9, #98d8c8);
            border-radius: 6px;
            transition: width 0.5s;
        }

        .webcam-status {
            font-size: 12px;
            color: #6e6e73;
        }

        /* Focus Buddy */
        .focus-buddy {
            margin-bottom: 24px;
        }

        .buddy-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .buddy-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .buddy-info h4 {
            font-size: 16px;
            font-weight: 600;
        }

        .buddy-info p {
            font-size: 12px;
            color: #6e6e73;
        }

        .language-badge {
            margin-left: auto;
            padding: 4px 12px;
            background: #f5f5f7;
            border-radius: 12px;
            font-size: 12px;
        }

        .buddy-message {
            background: #f5f5f7;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .chat-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e8e8ed;
            border-radius: 24px;
            font-size: 14px;
        }

        .mic-button {
            width: 40px;
            height: 40px;
            border: none;
            background: #5ec4a9;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .mic-button:hover {
            background: #4db396;
        }

        .mic-button.active {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Dopamine Menu */
        .dopamine-menu {
            margin-top: 24px;
        }

        .dopamine-menu h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: #d97706;
        }

        .dopamine-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .dopamine-item {
            padding: 12px;
            background: #fef3c7;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .dopamine-item:hover {
            border-color: #d97706;
            transform: translateY(-2px);
        }

        /* Tasks */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .tasks-header h2 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chunking-badge {
            background: #fef3c7;
            color: #d97706;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .add-task-btn {
            color: #5ec4a9;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .task-group {
            margin-bottom: 24px;
        }

        .task-group h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-progress {
            font-size: 12px;
            color: #6e6e73;
        }

        .subtask {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #fafafa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .subtask:hover {
            background: #f5f5f7;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d1d6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox.checked {
            background: #5ec4a9;
            border-color: #5ec4a9;
        }

        .subtask-text {
            flex: 1;
        }

        .subtask-text.completed {
            text-decoration: line-through;
            color: #6e6e73;
        }

        .subtask-duration {
            color: #6e6e73;
            font-size: 12px;
        }

        .progress-mini {
            width: 60px;
            height: 4px;
            background: #e8e8ed;
            border-radius: 2px;
        }

        .progress-mini-fill {
            height: 100%;
            background: #5ec4a9;
            border-radius: 2px;
        }

        /* Activity Insights */
        .activity-insights {
            margin-top: 24px;
            padding: 24px;
            background: #fafafa;
            border-radius: 12px;
        }

        .activity-insights h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6e6e73;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* Schedule View */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .date-nav {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .date-nav button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #6e6e73;
        }

        .bio-rhythm-card {
            background: linear-gradient(135deg, #e8f5f2 0%, #f0fdf4 100%);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .timeline {
            margin-top: 24px;
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #5ec4a9;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
            background: white;
            padding: 16px;
            border-radius: 12px;
        }

        .timeline-time {
            color: #6e6e73;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .energy-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 8px;
        }

        .energy-high {
            background: #d1fae5;
            color: #065f46;
        }

        .energy-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .energy-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Analytics View */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 4px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        /* Settings View */
        .settings-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 32px;
        }

        .settings-nav {
            background: white;
            padding: 16px;
            border-radius: 12px;
            height: fit-content;
        }

        .settings-nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-nav-item:hover {
            background: #f5f5f7;
        }

        .settings-nav-item.active {
            background: #e8f5f2;
            color: #5ec4a9;
        }

        .settings-section {
            background: white;
            padding: 32px;
            border-radius: 12px;
        }

        .settings-group {
            margin-bottom: 32px;
        }

        .settings-group h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .settings-group p {
            color: #6e6e73;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f5f5f7;
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: #d1d1d6;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #5ec4a9;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        select {
            padding: 8px 16px;
            border: 1px solid #e8e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Video Feed */
        .video-feed {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 16px;
        }

        .video-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hidden {
            display: none;
        }

        .mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings feedback banner */
        #settings-feedback {
            margin: 12px 0 0 0;
            padding: 10px 14px;
            border-radius: 10px;
            display: inline-block;
            font-size: 14px;
            box-shadow: 0 4px 16px rgba(2,6,23,0.08);
            transition: transform 180ms ease, opacity 180ms ease;
            opacity: 0.0;
            transform: translateY(-6px);
        }
        #settings-feedback.visible { opacity: 1.0; transform: translateY(0); }
        #settings-feedback.success { background: #e6ffed; color: #065f46; }
        #settings-feedback.warning { background: #fff4e5; color: #7a4a00; }

        /* Dynamic Settings Styles */
        body.dyslexia-font {
            font-family: 'OpenDyslexic', 'Dyslexie', Arial, Helvetica, sans-serif !important;
            /* Make dyslexic mode more visually distinct even if the font file isn't available */
            font-weight: 600 !important;
            letter-spacing: 0.4px !important;
            word-spacing: 1px !important;
            line-height: 1.6 !important;
            font-size: 1.02em !important;
            text-rendering: optimizeLegibility !important;
        }

        /* Dark mode */
        body.dark-mode {
            background: #0b1220;
            color: #e6eef6;
        }
        body.dark-mode .card,
        body.dark-mode .settings-section,
        body.dark-mode .settings-nav,
        body.dark-mode .chart-container,
        body.dark-mode .activity-insights,
        body.dark-mode .dopamine-menu,
        body.dark-mode .focus-buddy,
        body.dark-mode .tasks-header,
        body.dark-mode .task-group {
            background: #0f1724;
            box-shadow: none;
            color: #e6eef6;
        }
        body.dark-mode .sidebar {
            background: #071029;
            color: #cfe6ff;
        }
        body.dark-mode .main-content { background: transparent; }
        body.dark-mode .nav-item { color: #bcd7ef; }
        body.dark-mode .nav-item.active { background: transparent; color: #9fe3c9; }
        body.dark-mode .privacy-badge { background: rgba(94,196,169,0.08); color: #9fe3c9; }
        body.dark-mode .mic-button { background: #154046; color: #d1f7ef; }
        body.dark-mode .mic-button.active { background: #b91c1c; }
        body.dark-mode .add-task-btn { color: #9fe3c9; }
        body.dark-mode .toggle-switch { background: #25303a; }
        body.dark-mode .toggle-switch::after { background: #f3f7f9; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #071226; color: #e6eef6; border: 1px solid #21303f; }
        body.dark-mode .progress-bar { background: #071226; }
        body.dark-mode .progress-fill { background: linear-gradient(90deg,#2dd4bf,#7dd3fc); }
        body.dark-mode .dopamine-item { background: #071f2b; border: 1px solid #12323f; color: #d1f7ff; }
        body.dark-mode .subtask { background: #071226; color: #dbeef6; }
        body.dark-mode .chat-input input { background: #071226; color: #e6eef6; border-color: #21303f; }

        /* Color-blind friendly adjustments (high contrast but colorblind palette) */
        body.color-blind .dopamine-item { background: #e0f2ff; border-color: #0077b6; }
        body.color-blind .progress-fill { background: #0077b6; }

        /* Hide sidebar */
        .sidebar.hidden { width: 0; padding: 0; overflow: hidden; display: none; }

        /* Toolbar dark toggle */
        .toolbar-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid rgba(0,0,0,0.06);
            cursor: pointer;
            color: inherit;
            margin-left: 12px;
        }
        .toolbar-button.active { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }

        body.reduced-motion * {
            animation: none !important;
            transition: none !important;
        }

        body.high-contrast {
            color: #000000 !important;
            background: #FFFFFF !important;
        }

        body.maximum-contrast {
            color: #000000 !important;
            background: #FFFFFF !important;
            filter: contrast(200%);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">FOCUSFLOW</div>
            <nav>
                <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')">
                    ğŸ  Dashboard
                </div>
                <div class="nav-item" id="nav-schedule" onclick="showView('schedule')">
                    ğŸ“… Schedule
                </div>
                <div class="nav-item" id="nav-analytics" onclick="showView('analytics')">
                    ğŸ“Š Analytics
                </div>
                <div class="nav-item" id="nav-settings" onclick="showView('settings')">
                    âš™ï¸ Settings
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view">
                <div class="header">
                    <h1 id="greeting-prefix">Good <span id="greeting"></span>, Friend</h1>
                    <p id="ready-text">Ready to conquer your tasks today?</p>
                    <div class="privacy-badge" id="privacy-badge">
                        ğŸ”’ Privacy Mode: Local Processing Only
                    </div>
                    <!-- camera-notice removed; feedback displayed in Settings page -->
                </div>

                <div class="dashboard-grid">
                    <div>
                        <!-- Focus Status -->
                        <div class="card focus-status">
                            <h3 id="current-focus-label">CURRENT FOCUS</h3>
                            <div class="focus-meter">
                                <span id="focus-percentage">0%</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="focus-bar" style="width:0%"></div>
                                </div>
                            </div>

                            <p class="webcam-status">
                                <span id="webcam-status">Webcam inactive</span>. Monitoring gaze & posture.
                            </p>
                            <button class="mic-button" id="camera-toggle" onclick="toggleCamera()">
                                ğŸ“·
                            </button>
                            <div id="video-container" class="video-feed hidden">
                                <img id="video-feed" src="/video_feed" alt="Video Feed">
                            </div>
                        </div>

                        <!-- Focus Buddy -->
                        <div class="card focus-buddy">
                            <div class="buddy-header">
                                <div class="buddy-avatar">ğŸ¤–</div>
                                <div class="buddy-info">
                                    <h4 id="focus-buddy-title">Focus Buddy</h4>
                                    <p id="buddy-help-text">ALWAYS HERE TO HELP</p>
                                </div>
                                <div class="language-badge" id="current-lang-badge">English</div>
                            </div>

                            <div class="buddy-message" id="buddy-message">
                                Hi Friend! I noticed you've been staring at the wall. Let's finish this paragraph together?
                            </div>

                            <div class="chat-input">
                                <button class="mic-button" id="mic-toggle" onclick="startVoiceCapture()">ğŸ¤</button>
                                <input type="text" placeholder="Type or speak to Buddy..." id="chat-input" onkeypress="handleChatInput(event)">
                                <button style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="sendMessage()">â¤</button>
                            </div>
                        </div>

                        <!-- Dopamine Menu -->
                        <div class="card dopamine-menu">
                            <h4 id="dopamine-menu-title">â˜• Dopamine Menu</h4>
                            <div class="dopamine-grid">
                                <div class="dopamine-item" onclick="triggerBreak('jumping-jacks')">5 Jumping Jacks</div>
                                <div class="dopamine-item" onclick="triggerBreak('water')">Drink Water</div>
                                <div class="dopamine-item" onclick="triggerBreak('pet')">Pet the cat</div>
                                <div class="dopamine-item" onclick="triggerBreak('stretch')">Stretch</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="card">
                        <div class="tasks-header">
                            <h2 id="tasks-title">Tasks <span class="chunking-badge" id="chunking-badge">Chunking Active</span></h2>
                            <div class="add-task-btn" id="add-task-btn" onclick="addTask()">+ Add Task</div>
                        </div>

                        <div id="tasks-container"></div>

                        <div class="activity-insights">
                            <h4 id="activity-insights-title">âš¡ Activity Insights</h4>
                            <p id="activity-insights-desc" style="color: #6e6e73; font-size: 14px; margin-top: 8px;">
                                You're making great progress! Keep the momentum going.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule View -->
            <div id="schedule-view" class="view hidden">
                <div class="header">
                    <h1 id="schedule-title">Your Bio-Rhythm Schedule</h1>
                    <p id="schedule-desc">Optimized for your peak focus hours (<span id="peak-hours"></span>)</p>
                </div>

                <div class="schedule-header">
                    <h2 id="timeline-title">ğŸ“… Timeline</h2>
                    <div class="date-nav">
                        <button onclick="prevDay()">â†</button>
                        <span id="current-date">Today, Dec 17</span>
                        <button onclick="nextDay()">â†’</button>
                    </div>
                </div>

                <div class="bio-rhythm-card">
                    <h3 id="bio-rhythm-title">ğŸ§  BIO-RHYTHM INSIGHT</h3>
                    <h2 id="peak-focus-title">Peak Focus Time</h2>
                    <p id="peak-time-display"></p>
                    <p id="bio-insight" style="margin-top: 12px; color: #6e6e73;">
                        Based on your activity yesterday, you seem most alert in the late morning.
                        We've scheduled your hardest tasks (Math, HCI) during this window.
                    </p>
                </div>

                <div class="card">
                    <div class="timeline" id="schedule-timeline"></div>
                    
                    <div id="add-schedule-btn" style="text-align: center; padding: 24px; border: 2px dashed #e8e8ed; border-radius: 12px; cursor: pointer;" onclick="addScheduleTask()">
                        + Add Task to Schedule
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 id="daily-stats-title">DAILY STATS</h3>
                    <div style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span id="scheduled-label">Scheduled</span>
                            <span style="font-weight: 600;" id="scheduled-time">4h 30m</span>
                        </div>
                        <div class="progress-bar" style="margin-bottom: 16px;">
                            <div class="progress-fill" style="width: 75%"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between;">
                            <span id="breaks-label">Breaks</span>
                            <span style="font-weight: 600;" id="breaks-time">45m</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 30%; background: #fbbf24;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analytics-view" class="view hidden">
                <div class="header">
                    <h1 id="analytics-title">Weekly Insights</h1>
                    <p id="analytics-desc">Understanding your focus patterns to optimize your study routine.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e8f5f2;">ğŸ§ </div>
                        <div class="stat-value" id="deep-focus-score">78%</div>
                        <div style="color: #6e6e73; font-size: 14px;" id="deep-focus-label">Deep Focus Score</div>
                        <div class="stat-change positive">+5%</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ede9fe;">â±ï¸</div>
                        <div class="stat-value" id="total-focus-time">4h 12m</div>
                        <div style="color: #6e6e73; font-size: 14px;" id="total-focus-label">Total Focus Time</div>
                        <div class="stat-change positive">+30m</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #dbeafe;">ğŸ“ˆ</div>
                        <div class="stat-value" id="consistency">85%</div>
                        <div style="color: #6e6e73; font-size: 14px;" id="consistency-label">Consistency</div>
                        <div class="stat-change positive">Stable</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fed7aa;">âš ï¸</div>
                        <div class="stat-value" id="distractions">12</div>
                        <div style="color: #6e6e73; font-size: 14px;" id="distractions-label">Distractions</div>
                        <div class="stat-change negative">-3</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 id="focus-rhythm-title">Focus Rhythm</h3>
                    <p style="color: #6e6e73; margin-bottom: 24px;" id="focus-rhythm-desc">Your attention levels throughout the day</p>
                    <canvas id="focus-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 id="distraction-title">Distraction Sources</h3>
                    <p style="color: #6e6e73; margin-bottom: 24px;" id="distraction-desc">What broke your flow today?</p>
                    <div id="distraction-chart"></div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #e8f5f2 0%, #f0fdf4 100%); margin-top: 24px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px;">ğŸ§ </div>
                        <div>
                            <h3 id="ai-insight-title">AI Insight: Peak Performance</h3>
                            <p style="margin-top: 8px;" id="ai-insight-desc">Friend, your focus consistently peaks between <strong id="peak-insight-time">10:00 AM and 11:30 AM</strong>. We recommend scheduling your most challenging subjects (like Math) during this window for maximum retention.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view hidden">
                <div class="header">
                    <h1 id="settings-title">Settings & Preferences</h1>
                    <p id="settings-desc">Customize your FocusFlow experience to match your needs.</p>
                </div>

                <div class="settings-layout">
                    <div class="settings-nav">
                        <div class="settings-nav-item active" id="accessibility-id" onclick="showSettingsSection('accessibility')">
                            â™¿ Accessibility
                        </div>
                        <div class="settings-nav-item" id="focusbuddy-id" onclick="showSettingsSection('buddy')">
                            ğŸ¤– Focus Buddy
                        </div>
                        <div class="settings-nav-item" id="privacy-id" onclick="showSettingsSection('privacy')">
                            ğŸ”’ Privacy
                        </div>
                    </div>

                    <div class="settings-section" id="settings-content">
                        <div id="settings-feedback" class="hidden" role="status" aria-live="polite"></div>
                        <div id="accessibility-settings">
                            <div class="settings-group" id="a&s-id">
                                <h3>â™¿ Accessibility & Sensory</h3>
                                <p>Adjust the interface for your comfort.</p>

                                <div class="setting-item">
                                    <div>
                                        <strong id="dyslexia-label">Dyslexia Friendly Font</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Switches text to OpenDyslexic or similar accessible font.
                                        </p>
                                    </div>
                                            <div class="toggle-switch" id="dyslexia-toggle" onclick="toggleSetting('dyslexia_font')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="darkmode-label">Dark Mode</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Switch to a dark theme to reduce glare.</p>
                                            </div>
                                            <div class="toggle-switch" id="darkmode-toggle" onclick="toggleSetting('dark_mode')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="colorblind-label">Color Blind Mode</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Use a color-blind friendly palette for key UI elements.</p>
                                            </div>
                                            <div class="toggle-switch" id="colorblind-toggle" onclick="toggleSetting('color_blind_mode')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="sidebar-label">Hide Sidebar</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Collapse the left navigation to focus on content.</p>
                                            </div>
                                            <div class="toggle-switch" id="sidebar-toggle" onclick="toggleSetting('hide_sidebar')"></div>
                                        </div>

                                <!-- Reduced Motion option removed per user request -->

                                <div class="setting-item">
                                    <div>
                                        <strong id="contrast-label">Color Contrast</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Adjust contrast level
                                        </p>
                                    </div>
                                    <select id="contrast-select" onchange="updateSetting('color_contrast', this.value)">
                                        <option value="Standard">Standard</option>
                                        <option value="High">High</option>
                                        <option value="Maximum">Maximum</option>
                                    </select>
                                </div>
                            </div>

                            <div class="settings-group" id="fb-id">
                                <h3>ğŸ¤– Focus Companion</h3>
                                <p>Configure how your AI buddy interacts with you.</p>

                                <div class="setting-item">
                                    <div>
                                        <strong id="persona-label">Buddy Persona</strong>
                                    </div>
                                    <select id="persona-select" onchange="updateSetting('buddy_persona', this.value)">
                                        <option value="Friendly Peer">Friendly Peer (Default)</option>
                                        <option value="Gentle Mentor">Gentle Mentor</option>
                                        <option value="Motivational Coach">Motivational Coach</option>
                                    </select>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="language-label">Primary Language</strong>
                                    </div>
                                    <select id="language-select" onchange="updateSetting('language', this.value)">
                                        <option value="English">English</option>
                                        <option value="Urdu">Urdu</option>
                                        <option value="Mixed">Mixed (Code-switching)</option>
                                    </select>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="intervention-label">Proactive Interventions</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Allow Buddy to speak when you lose focus.
                                        </p>
                                    </div>
                                    <div class="toggle-switch active" id="intervention-toggle" onclick="toggleSetting('proactive_interventions')"></div>
                                </div>
                            </div>

                            <div class="settings-group" id="ph-id">
                                <h3>ğŸ”’ Privacy & Hardware</h3>
                                <p>Manage permissions and data processing.</p>

                                <div class="card" style="background: #e8f5f2; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span style="font-size: 24px;">ğŸ”’</span>
                                        <div>
                                            <strong style="color: #5ec4a9;" id="local-processing-title">Local Edge Processing Active</strong>
                                            <p style="font-size: 12px; margin-top: 4px; color: #6e6e73;" id="local-processing-desc">
                                                Your camera feed is processed on-device and never sent to the cloud.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="camera-label">Camera Access</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Required for gaze tracking.
                                        </p>
                                    </div>
                                    <div class="toggle-switch active" id="camera-access-toggle" onclick="toggleSetting('camera_access')"></div>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="mic-label">Microphone Access</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Required for voice commands.
                                        </p>
                                    </div>
                                    <div>
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <div class="toggle-switch active" id="mic-access-toggle" onclick="toggleMicrophoneWithFeedback()"></div>
                                            <select id="mic-device-select" style="margin-left:8px; padding:6px; font-size:13px;"></select>
                                            <button style="margin-left:6px; padding:6px 8px;" onclick="populateMicDevices()">Refresh</button>
                                            <div id="mic-level-wrap" style="display:flex; align-items:center; gap:8px; margin-left:8px;">
                                                <div id="mic-level-meter" style="width:120px; height:10px; background:#eee; border-radius:6px; overflow:hidden;"></div>
                                                <div id="mic-level-value" style="font-size:12px; color:#6e6e73;">â€”</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Translation Dictionary
        const translations = {
            English: {
                greetingPrefix: "Good",
                readyText: "Ready to conquer your tasks today?",
                privacyBadge: "Privacy Mode: Local Processing Only",
                currentFocusLabel: "CURRENT FOCUS",
                webcamInactive: "Webcam inactive",
                webcamActive: "Webcam active",
                focusBuddyTitle: "Focus Buddy",
                buddyHelpText: "ALWAYS HERE TO HELP",
                currentLangBadge: "English",
                dopamineMenuTitle: "Dopamine Menu",
                tasksTitle: "Tasks",
                chunkingBadge: "Chunking Active",
                addTaskBtn: "+ Add Task",
                activityInsightsTitle: "Activity Insights",
                activityInsightsDesc: "You're making great progress! Keep the momentum going.",
                scheduleTitle: "Your Bio-Rhythm Schedule",
                scheduleDesc: "Optimized for your peak focus hours",
                timelineTitle: "Timeline",
                bioRhythmTitle: "BIO-RHYTHM INSIGHT",
                peakFocusTitle: "Peak Focus Time",
                addScheduleBtn: "+ Add Task to Schedule",
                dailyStatsTitle: "DAILY STATS",
                scheduledLabel: "Scheduled",
                breaksLabel: "Breaks",
                analyticsTitle: "Weekly Insights",
                analyticsDesc: "Understanding your focus patterns to optimize your study routine.",
                deepFocusLabel: "Deep Focus Score",
                totalFocusLabel: "Total Focus Time",
                consistencyLabel: "Consistency",
                distractionsLabel: "Distractions",
                focusRhythmTitle: "Focus Rhythm",
                focusRhythmDesc: "Your attention levels throughout the day",
                distractionTitle: "Distraction Sources",
                distractionDesc: "What broke your flow today?",
                aiInsightTitle: "AI Insight: Peak Performance",
                aiInsightDesc: "Friend, your focus consistently peaks between <strong>10:00 AM and 11:30 AM</strong>. We recommend scheduling your most challenging subjects (like Math) during this window for maximum retention.",
                settingsTitle: "Settings & Preferences",
                settingsDesc: "Customize your FocusFlow experience to match your needs.",
                dyslexiaLabel: "Dyslexia Friendly Font",
                reducedMotionLabel: "Reduced Motion",
                contrastLabel: "Color Contrast",
                personaLabel: "Buddy Persona",
                languageLabel: "Primary Language",
                interventionLabel: "Proactive Interventions",
                localProcessingTitle: "Local Edge Processing Active",
                localProcessingDesc: "Your camera feed is processed on-device and never sent to the cloud.",
                cameraLabel: "Camera Access",
                micLabel: "Microphone Access",
                navDashboard: "Dashboard",
                navSchedule: "Schedule",
                navAnalytics: "Analytics",
                navSettings: "Settings",
                accessibilitytitle: "Accessibility",
                focusbuddytitle:"Focus Buddy",
                privacytitle:"Privacy"

            },
            Urdu: {
                greetingPrefix: "Ø§Ú†Ú¾Ø§",
                readyText: "Ú©ÛŒØ§ Ø¢Ù¾ Ø¢Ø¬ Ø§Ù¾Ù†Û’ Ú©Ø§Ù… Ù…Ú©Ù…Ù„ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ ØªÛŒØ§Ø± ÛÛŒÚºØŸ",
                privacyBadge: "Ù¾Ø±Ø§Ø¦ÛŒÙˆÛŒØ³ÛŒ Ù…ÙˆÚˆ: ØµØ±Ù Ù„ÙˆÚ©Ù„ Ù¾Ø±ÙˆØ³ÛŒØ³Ù†Ú¯",
                currentFocusLabel: "Ù…ÙˆØ¬ÙˆØ¯Û ØªÙˆØ¬Û",
                webcamInactive: "ÙˆÛŒØ¨ Ú©ÛŒÙ… ØºÛŒØ± ÙØ¹Ø§Ù„",
                webcamActive: "ÙˆÛŒØ¨ Ú©ÛŒÙ… ÙØ¹Ø§Ù„",
                focusBuddyTitle: "ÙÙˆÚ©Ø³ Ø¨ÚˆÛŒ",
                buddyHelpText: "ÛÙ…ÛŒØ´Û Ù…Ø¯Ø¯ Ú©Û’ Ù„ÛŒÛ’ Ù…ÙˆØ¬ÙˆØ¯",
                currentLangBadge: "Ø§Ø±Ø¯Ùˆ",
                dopamineMenuTitle: "ÚˆÙˆÙ¾Ø§Ù…ÛŒÙ† Ù…ÛŒÙ†Ùˆ",
                tasksTitle: "Ú©Ø§Ù…",
                chunkingBadge: "Ù¹Ø§Ø³Ú© ØªÙ‚Ø³ÛŒÙ… ÙØ¹Ø§Ù„",
                addTaskBtn: "+ Ù†ÛŒØ§ Ú©Ø§Ù… Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
                activityInsightsTitle: "Ø³Ø±Ú¯Ø±Ù…ÛŒ Ú©ÛŒ Ø¨ØµÛŒØ±Øª",
                activityInsightsDesc: "Ø¢Ù¾ Ø²Ø¨Ø±Ø¯Ø³Øª ØªØ±Ù‚ÛŒ Ú©Ø± Ø±ÛÛ’ ÛÛŒÚº! Ø±ÙØªØ§Ø± Ø¨Ø±Ù‚Ø±Ø§Ø± Ø±Ú©Ú¾ÛŒÚºÛ”",
                scheduleTitle: "Ø¢Ù¾ Ú©Ø§ Ø¨Ø§Ø¦ÛŒÙˆ Ø±Ø¯Ù… Ø´ÛŒÚˆÙˆÙ„",
                scheduleDesc: "Ø¢Ù¾ Ú©Û’ Ù¾ÛŒÚ© ÙÙˆÚ©Ø³ Ø§ÙˆÙ‚Ø§Øª Ú©Û’ Ù„ÛŒÛ’ Ø¨ÛØªØ± Ø¨Ù†Ø§ÛŒØ§ Ú¯ÛŒØ§",
                timelineTitle: "Ù¹Ø§Ø¦Ù… Ù„Ø§Ø¦Ù†",
                bioRhythmTitle: "Ø¨Ø§Ø¦ÛŒÙˆ Ø±Ø¯Ù… Ø¨ØµÛŒØ±Øª",
                peakFocusTitle: "Ù¾ÛŒÚ© ÙÙˆÚ©Ø³ ÙˆÙ‚Øª",
                addScheduleBtn: "+ Ø´ÛŒÚˆÙˆÙ„ Ù…ÛŒÚº Ú©Ø§Ù… Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº",
                dailyStatsTitle: "Ø±ÙˆØ²Ø§Ù†Û Ú©Û’ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø´Ù…Ø§Ø±",
                scheduledLabel: "Ø´ÛŒÚˆÙˆÙ„ Ø´Ø¯Û",
                breaksLabel: "ÙˆÙ‚ÙÛ’",
                analyticsTitle: "ÛÙØªÛ ÙˆØ§Ø± Ø¨ØµÛŒØ±Øª",
                analyticsDesc: "Ø§Ù¾Ù†Û’ ØªÙˆØ¬Û Ú©Û’ Ù†Ù…ÙˆÙ†ÙˆÚº Ú©Ùˆ Ø³Ù…Ø¬Ú¾ Ú©Ø± Ù…Ø·Ø§Ù„Ø¹Û Ú©Ø§ Ù…Ø¹Ù…ÙˆÙ„ Ø¨ÛØªØ± Ø¨Ù†Ø§Ø¦ÛŒÚºÛ”",
                deepFocusLabel: "Ú¯ÛØ±ÛŒ ØªÙˆØ¬Û Ú©Ø§ Ø³Ú©ÙˆØ±",
                totalFocusLabel: "Ú©Ù„ ØªÙˆØ¬Û Ú©Ø§ ÙˆÙ‚Øª",
                consistencyLabel: "Ù…Ø³ØªÙ‚Ù„ Ù…Ø²Ø§Ø¬ÛŒ",
                distractionsLabel: "Ø®Ù„ÙØ´Ø§Ø±",
                focusRhythmTitle: "ØªÙˆØ¬Û Ú©Ø§ Ø±Ø¯Ù…",
                focusRhythmDesc: "Ø¯Ù† Ø¨Ú¾Ø± Ù…ÛŒÚº Ø¢Ù¾ Ú©ÛŒ ØªÙˆØ¬Û Ú©ÛŒ Ø³Ø·Ø­",
                distractionTitle: "Ø®Ù„ÙØ´Ø§Ø± Ú©Û’ Ø°Ø±Ø§Ø¦Ø¹",
                distractionDesc: "Ø¢Ø¬ Ú©Ø³ Ú†ÛŒØ² Ù†Û’ Ø¢Ù¾ Ú©Ø§ Ø¨ÛØ§Ø¤ ØªÙˆÚ‘Ø§ØŸ",
                aiInsightTitle: "Ø§Û’ Ø¢Ø¦ÛŒ Ø¨ØµÛŒØ±Øª: Ù¾ÛŒÚ© Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ",
                aiInsightDesc: "Ø¯ÙˆØ³ØªØŒ Ø¢Ù¾ Ú©ÛŒ ØªÙˆØ¬Û Ù…Ø³ØªÙ‚Ù„ Ø·ÙˆØ± Ù¾Ø± <strong>ØµØ¨Ø­ 10:00 Ø³Û’ 11:30</strong> Ú©Û’ Ø¯Ø±Ù…ÛŒØ§Ù† Ø¹Ø±ÙˆØ¬ Ù¾Ø± ÛÙˆØªÛŒ ÛÛ’Û” ÛÙ… ØªØ¬ÙˆÛŒØ² Ú©Ø±ØªÛ’ ÛÛŒÚº Ú©Û Ù…Ø´Ú©Ù„ Ù…Ø¶Ø§Ù…ÛŒÙ† (Ø¬ÛŒØ³Û’ Ø±ÛŒØ§Ø¶ÛŒ) Ø§Ø³ ÙˆÙ‚Øª Ø´ÛŒÚˆÙˆÙ„ Ú©Ø±ÛŒÚºÛ”",
                settingsTitle: "ØªØ±ØªÛŒØ¨Ø§Øª Ø§ÙˆØ± ØªØ±Ø¬ÛŒØ­Ø§Øª",
                settingsDesc: "Ø§Ù¾Ù†Û’ FocusFlow ØªØ¬Ø±Ø¨Û’ Ú©Ùˆ Ø§Ù¾Ù†ÛŒ Ø¶Ø±ÙˆØ±ÛŒØ§Øª Ú©Û’ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ù†Ø§Ø¦ÛŒÚºÛ”",
                dyslexiaLabel: "ÚˆØ³Ù„ÛŒÚ©Ø³Ú© Ú©Û’ Ù„ÛŒÛ’ Ù…ÙˆØ²ÙˆÚº ÙÙˆÙ†Ù¹",
                reducedMotionLabel: "Ø­Ø±Ú©Ø§Øª Ú©Ù… Ú©Ø±ÛŒÚº",
                contrastLabel: "Ø±Ù†Ú¯ Ú©Ø§ ØªØ¶Ø§Ø¯",
                personaLabel: "Ø¨ÚˆÛŒ Ø´Ø®ØµÛŒØª",
                languageLabel: "Ø¨Ù†ÛŒØ§Ø¯ÛŒ Ø²Ø¨Ø§Ù†",
                interventionLabel: "ÙØ¹Ø§Ù„ Ù…Ø¯Ø§Ø®Ù„Øª",
                localProcessingTitle: "Ù„ÙˆÚ©Ù„ Ø§ÛŒØ¬ Ù¾Ø±ÙˆØ³ÛŒØ³Ù†Ú¯ ÙØ¹Ø§Ù„",
                localProcessingDesc: "Ø¢Ù¾ Ú©Ø§ Ú©ÛŒÙ…Ø±Û ÙÛŒÚˆ ÚˆÛŒÙˆØ§Ø¦Ø³ Ù¾Ø± Ù¾Ø±ÙˆØ³ÛŒØ³ ÛÙˆØªØ§ ÛÛ’ Ø§ÙˆØ± Ú©Ù„Ø§Ø¤Úˆ Ù¾Ø± Ù†ÛÛŒÚº Ø¨Ú¾ÛŒØ¬Ø§ Ø¬Ø§ØªØ§Û”",
                cameraLabel: "Ú©ÛŒÙ…Ø±Û Ø±Ø³Ø§Ø¦ÛŒ",
                micLabel: "Ù…Ø§Ø¦ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø³Ø§Ø¦ÛŒ",
                navDashboard: "ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ",
                navSchedule: "Ø´ÛŒÚˆÙˆÙ„",
                navAnalytics: "ØªØ¬Ø²ÛŒØ§Øª",
                navSettings: "ØªØ±ØªÛŒØ¨Ø§Øª",
                accessibilitytitle: "Ø±Ø³Ø§Ø¦ÛŒ",
                focusbuddytitle:"ØªÙˆØ¬Û Ú©Ø§ Ø³Ø§ØªÚ¾ÛŒ",
                privacytitle:"Ø±Ø§Ø²Ø¯Ø§Ø±ÛŒ"
            }
        };

        // State management
        let appState = {
            currentView: 'dashboard',
            cameraActive: false,
            microphoneActive: false,
            focusScore: 0,
            tasks: [],
            schedule: [],
            analytics: {},
            focusHistory: [],
            settings: {
                language: 'English',
                proactive_interventions: true,
                dyslexia_font: false,
                dark_mode: false,
                color_blind_mode: false,
                hide_sidebar: false,
                color_contrast: 'Standard',
                buddy_persona: 'Friendly Peer',
                camera_access: true
            },
            audioInitialized: false
        };

        let currentScheduleDate = new Date();

        // Apply Language
        function applyLanguage() {
            const lang = appState.settings.language;
            const t = translations[lang];

            document.body.dir = lang === 'Urdu' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang === 'Urdu' ? 'ur' : 'en';

            // Greeting
            const hour = new Date().getHours();
            let timeOfDay = 'Morning';
            if (hour >= 12 && hour < 17) timeOfDay = 'Afternoon';
            if (hour >= 17) timeOfDay = 'Evening';
            document.getElementById('greeting').textContent = timeOfDay;
            document.getElementById('greeting-prefix').innerHTML = `${t.greetingPrefix} <span id="greeting">${timeOfDay}</span>, Friend`;

            // Safe text update function
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };
            const setHTML = (id, html) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            };

            setText('ready-text', t.readyText);
            setText('privacy-badge', `ğŸ”’ ${t.privacyBadge}`);
            setText('current-focus-label', t.currentFocusLabel);
            setText('webcam-status', appState.cameraActive ? t.webcamActive : t.webcamInactive);
            setText('focus-buddy-title', t.focusBuddyTitle);
            setText('buddy-help-text', t.buddyHelpText);
            setText('current-lang-badge', t.currentLangBadge);
            setText('dopamine-menu-title', t.dopamineMenuTitle);
            setText('tasks-title', t.tasksTitle);
            setText('chunking-badge', t.chunkingBadge);
            setText('add-task-btn', t.addTaskBtn);
            setText('activity-insights-title', t.activityInsightsTitle);
            setText('activity-insights-desc', t.activityInsightsDesc);
            setText('schedule-title', t.scheduleTitle);
            setHTML('schedule-desc', `${t.scheduleDesc} (<span id="peak-hours"></span>)`);
            setText('timeline-title', t.timelineTitle);
            setText('bio-rhythm-title', t.bioRhythmTitle);
            setText('peak-focus-title', t.peakFocusTitle);
            setText('add-schedule-btn', t.addScheduleBtn);
            setText('daily-stats-title', t.dailyStatsTitle);
            setText('scheduled-label', t.scheduledLabel);
            setText('breaks-label', t.breaksLabel);
            setText('analytics-title', t.analyticsTitle);
            setText('analytics-desc', t.analyticsDesc);
            setText('deep-focus-label', t.deepFocusLabel);
            setText('total-focus-label', t.totalFocusLabel);
            setText('consistency-label', t.consistencyLabel);
            setText('distractions-label', t.distractionsLabel);
            setText('focus-rhythm-title', t.focusRhythmTitle);
            setText('focus-rhythm-desc', t.focusRhythmDesc);
            setText('distraction-title', t.distractionTitle);
            setText('distraction-desc', t.distractionDesc);
            setText('ai-insight-title', t.aiInsightTitle);
            // Only set the static AI insight description if it hasn't been replaced by dynamic content
            const aiDescEl = document.getElementById('ai-insight-desc');
            if (aiDescEl && aiDescEl.dataset.dynamic !== 'true') aiDescEl.innerHTML = t.aiInsightDesc;
            setText('settings-title', t.settingsTitle);
            setText('settings-desc', t.settingsDesc);
            setText('dyslexia-label', t.dyslexiaLabel);
            setText('reduced-motion-label', t.reducedMotionLabel);
            setText('contrast-label', t.contrastLabel);
            setText('persona-label', t.personaLabel);
            setText('language-label', t.languageLabel);
            setText('intervention-label', t.interventionLabel);
            setText('local-processing-title', t.localProcessingTitle);
            setText('local-processing-desc', t.localProcessingDesc);
            setText('camera-label', t.cameraLabel);
            setText('mic-label', t.micLabel);
            setText('accessibility-id', t.accessibilitytitle);
            setText('focusbuddy-id', t.focusbuddytitle);
            setText('privacy-id', t.privacytitle);

            // Sidebar
            setText('nav-dashboard', `ğŸ  ${t.navDashboard}`);
            setText('nav-schedule', `ğŸ“… ${t.navSchedule}`);
            setText('nav-analytics', `ğŸ“Š ${t.navAnalytics}`);
            setText('nav-settings', `âš™ï¸ ${t.navSettings}`);
        }

        // Initialize app
        async function init() {
            updateGreeting();
            await loadState();
            renderTasks();
            applyLanguage(); // Initial apply

            // Populate microphone devices in settings
            try { populateMicDevices(); } catch (e) { console.warn('populateMicDevices failed', e); }

            document.body.addEventListener('click', () => {
                if (!appState.audioInitialized) {
                    const prime = new SpeechSynthesisUtterance("");
                    window.speechSynthesis.speak(prime);
                    appState.audioInitialized = true;
                    console.log("Audio Engine Unlocked");
                }

                // Also attempt to create/resume the notification audio context on first user gesture
                try {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (AudioCtx && !notificationAudioCtx) {
                        notificationAudioCtx = new AudioCtx();
                        if (notificationAudioCtx.state === 'suspended') notificationAudioCtx.resume().catch(() => {});
                    } else if (notificationAudioCtx && notificationAudioCtx.state === 'suspended') {
                        notificationAudioCtx.resume().catch(() => {});
                    }
                } catch (e) { /* ignore */ }
            }, { once: true });

            setInterval(updateState, 300);
            setInterval(checkBuddyMessages, 3000);
        }

        function updateGreeting() {
            // Called inside applyLanguage now
        }

        async function loadState() {
            try {
                const response = await fetch('/api/state');
                const data = await response.json();

                appState = {
                    ...appState,
                    focusScore: data.focus_score || 0,
                    cameraActive: data.camera_active || false,
                    microphoneActive: data.microphone_active || false,
                    tasks: data.tasks || [],
                    analytics: data.analytics || {},
                    settings: { ...appState.settings, ...data.settings }
                };

                updateUI();
                updateFocusDisplay();
                applySettings();
                applyLanguage();
            } catch (error) {
                console.error('Error loading state:', error);
                applyLanguage(); // Still apply default
            }
        }

        async function updateState() {
            await loadState();
            updateFocusDisplay();
            updateUI();
        }

        function updateFocusDisplay() {
            const focusPercentage = document.getElementById('focus-percentage');
            const focusBar = document.getElementById('focus-bar');
            if (focusPercentage && focusBar) {
                focusPercentage.textContent = appState.focusScore + '%';
                focusBar.style.width = appState.focusScore + '%';

                // Update fill color based on focus score
                const fillEl = (focusBar.classList && focusBar.classList.contains('progress-fill')) ? focusBar : focusBar.querySelector('.progress-fill');
                if (fillEl) {
                    const score = Number(appState.focusScore) || 0;
                    if (score >= 75) {
                        fillEl.style.background = 'linear-gradient(90deg, #5ec4a9, #98d8c8)';
                    } else if (score >= 50) {
                        fillEl.style.background = 'linear-gradient(90deg, #fbbf24, #f97316)';
                    } else {
                        fillEl.style.background = 'linear-gradient(90deg, #ef4444, #f43f5e)';
                    }
                }

                appState.focusHistory.push(appState.focusScore);
                if (appState.focusHistory.length > 20) appState.focusHistory.shift();
            }
        }

        function updateUI() {
            if (appState.cameraActive) {
                document.getElementById('webcam-status').textContent = translations[appState.settings.language].webcamActive;
                document.getElementById('video-container').classList.remove('hidden');
            } else {
                document.getElementById('webcam-status').textContent = translations[appState.settings.language].webcamInactive;
                document.getElementById('video-container').classList.add('hidden');
            }

            // Sync camera UI toggles (settings permission + main camera button)
            const cameraSettingsToggle = document.getElementById('camera-access-toggle');
            const cameraMainButton = document.getElementById('camera-toggle');
            if (cameraSettingsToggle) cameraSettingsToggle.classList.toggle('active', !!appState.settings.camera_access);
            if (cameraMainButton) {
                cameraMainButton.classList.toggle('active', !!appState.cameraActive);
                cameraMainButton.disabled = !appState.settings.camera_access;
            }

            // Sync microphone UI toggles (chat mic button + settings toggle)
            const micButton = document.getElementById('mic-toggle');
            const micSettingsToggle = document.getElementById('mic-access-toggle');
            if (micButton) micButton.classList.toggle('active', !!appState.microphoneActive);
            if (micSettingsToggle) micSettingsToggle.classList.toggle('active', !!appState.microphoneActive);

            if (appState.analytics) {
                const deepFocusEl = document.getElementById('deep-focus-score');
                const totalTimeEl = document.getElementById('total-focus-time');
                const consistencyEl = document.getElementById('consistency');
                const distractionsEl = document.getElementById('distractions');

                if (deepFocusEl) deepFocusEl.textContent = (appState.analytics.deep_focus_score || 78) + '%';
                if (totalTimeEl) totalTimeEl.textContent = appState.analytics.total_focus_time || "4h 12m";
                if (consistencyEl) consistencyEl.textContent = (appState.analytics.consistency || 85) + '%';
                if (distractionsEl) distractionsEl.textContent = appState.analytics.distractions || 12;

                if (appState.currentView === 'analytics') {
                    renderDistractionChart();
                    renderFocusChart();
                }
            }
        }

        function speakMessage(text) {
            if (!appState.settings.proactive_interventions || !appState.audioInitialized) return;
            window.speechSynthesis.cancel();
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const langMap = { 'English': 'en-US', 'Urdu': 'ur-PK', 'Mixed': 'en-US' };
                utterance.lang = langMap[appState.settings.language] || 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Show a temporary notice when camera access is disabled
        function showCameraAccessNotice() {
            showFeedback('Camera access is disabled in Settings. Enable it there to use the camera.', 'warning');
        }

        // Lightweight, ear-friendly notification sound using WebAudio
        // Gentle sine chime with soft attack and decay
        let notificationAudioCtx = null;
        function playNotificationSound() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                if (!notificationAudioCtx) notificationAudioCtx = new AudioCtx();

                // Resume if suspended due to autoplay policies
                if (notificationAudioCtx.state === 'suspended') {
                    notificationAudioCtx.resume().catch(() => {});
                }

                const now = notificationAudioCtx.currentTime;

                // Master gain (low volume for comfort)
                const masterGain = notificationAudioCtx.createGain();
                masterGain.gain.value = 0.0;
                masterGain.connect(notificationAudioCtx.destination);

                // Main gentle sine tone (pleasant frequency)
                const tone = notificationAudioCtx.createOscillator();
                tone.type = 'sine';
                tone.frequency.value = 880; // A5, but we'll keep it soft
                tone.connect(masterGain);

                // Subtle harmonic for warmth
                const harmonic = notificationAudioCtx.createOscillator();
                harmonic.type = 'sine';
                harmonic.frequency.value = 1320; // 1.5x harmonic
                const harmGain = notificationAudioCtx.createGain();
                harmGain.gain.value = 0.12; // much quieter harmonic
                harmonic.connect(harmGain);
                harmGain.connect(masterGain);

                // Envelope: soft attack and slow decay
                const attack = 0.02;
                const sustain = 0.18;
                const decay = 0.36;

                masterGain.gain.setValueAtTime(0.0, now);
                masterGain.gain.linearRampToValueAtTime(0.06, now + attack); // soft peak
                masterGain.gain.exponentialRampToValueAtTime(0.0001, now + attack + sustain + decay);

                tone.start(now);
                harmonic.start(now + 0.01);

                tone.stop(now + attack + sustain + decay + 0.02);
                harmonic.stop(now + attack + sustain + decay + 0.02);
            } catch (e) {
                // ignore audio errors
            }
        }

        // General feedback helper
        function showFeedback(message, type = 'success', ms = 3000) {
            const el = document.getElementById('settings-feedback');
            if (!el) return;
            el.textContent = message;
            el.className = ''; // reset
            el.classList.add(type === 'warning' ? 'warning' : 'success');
            // animate visible
            el.classList.add('visible');
            // play sound for the notification
            playNotificationSound();
            // hide after timeout
            setTimeout(() => {
                el.classList.remove('visible');
            }, ms);
        }

        function showView(viewName) {
            const views = ['dashboard', 'schedule', 'analytics', 'settings'];
            views.forEach(view => {
                const element = document.getElementById(view + '-view');
                if (element) {
                    element.classList.toggle('hidden', view !== viewName);
                }
            });

            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.toggle('active', views[index] === viewName);
            });

            appState.currentView = viewName;

            if (viewName === 'schedule') loadSchedule();
            if (viewName === 'analytics') loadAnalytics();
        }

        async function toggleCamera() {
            // Respect the camera access setting
            if (!appState.settings.camera_access) {
                showCameraAccessNotice();
                return;
            }

            try {
                const response = await fetch('/api/toggle_camera', { method: 'POST' });
                const data = await response.json();
                appState.cameraActive = data.camera_active;
                updateUI();
            } catch (error) {
                console.error('Error toggling camera:', error);
            }
        }

        async function toggleMicrophone() {
            try {
                const response = await fetch('/api/toggle_microphone', { method: 'POST' });
                const data = await response.json();
                appState.microphoneActive = data.microphone_active;
                updateUI();
            } catch (error) {
                console.error('Error toggling microphone:', error);
            }
        }

        // Provide feedback when microphone is toggled
        async function toggleMicrophoneWithFeedback() {
            try {
                const response = await fetch('/api/toggle_microphone', { method: 'POST' });
                const data = await response.json();
                appState.microphoneActive = data.microphone_active;
                updateUI();
                showFeedback(appState.microphoneActive ? 'Microphone turned on' : 'Microphone turned off');
            } catch (error) {
                console.error('Error toggling microphone:', error);
            }
        }

        // Start speech recognition and send transcript to server for processing
        async function populateMicDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const list = devices.filter(d => d.kind === 'audioinput');
                const sel = document.getElementById('mic-device-select');
                if (!sel) return;
                sel.innerHTML = '';
                list.forEach((d, i) => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `Microphone ${i+1}`;
                    sel.appendChild(opt);
                });
                const saved = (appState.settings && appState.settings.mic_device_id) ? appState.settings.mic_device_id : localStorage.getItem('mic_device_id');
                if (saved) sel.value = saved;
                sel.onchange = () => {
                    const id = sel.value;
                    appState.settings.mic_device_id = id;
                    localStorage.setItem('mic_device_id', id);
                    try { updateSetting('mic_device_id', id); } catch (e) { console.warn('save mic id failed', e); }
                };
            } catch (e) { console.warn('populateMicDevices error', e); }
        }

        function updateMicMeter(rms) {
            try {
                const meter = document.getElementById('mic-level-meter');
                const valEl = document.getElementById('mic-level-value');
                if (!meter) return;
                const normalized = Math.min(1, rms * 200); // scale small RMS to 0..1
                meter.innerHTML = `<div style="height:100%; width:${Math.round(normalized*100)}%; background:#5ec4a9;"></div>`;
                if (valEl) valEl.textContent = normalized > 0 ? (Math.round(normalized*100) + '%') : 'â€”';
            } catch (e) { console.warn('updateMicMeter error', e); }
        }

        async function startVoiceCapture() {
    // Ensure browser supports Web Speech API
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showFeedback('Speech recognition not supported in this browser.', 'warning');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = appState.settings.language === 'Urdu' ? 'ur-PK' : 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let heardSomething = false;

    recognition.onstart = () => {
        console.log('Recognition started');
        showFeedback('Listening...', 'success', 2000);
        appState.microphoneActive = true;
        updateUI();
    };

    recognition.onresult = async (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        transcript = transcript.trim();
        console.log('Transcript:', transcript);
        heardSomething = true;

        if (!transcript) return;

        const buddyEl = document.getElementById('buddy-message');
        if (buddyEl) buddyEl.textContent = 'You: ' + transcript;

        // Send to server
        try {
            const resp = await fetch('/api/voice_command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transcript: transcript })
            });
            const data = await resp.json();
            const serverReply = data.reply || "I couldn't process that.";
            
            if (buddyEl) buddyEl.textContent = serverReply;
            speakMessage(serverReply);

            if (data.action) {
                handleServerAction(data.action);
            }
        } catch (err) {
            console.error('Voice command error', err);
            showFeedback('Failed to send voice command', 'warning');
        }
    };

    recognition.onerror = (e) => {
        console.error('Recognition error', e);
        showFeedback('Speech recognition error: ' + (e.error || 'unknown'), 'warning', 3000);
        appState.microphoneActive = false;
        updateUI();
    };

    recognition.onend = () => {
        console.log('Recognition ended');
        appState.microphoneActive = false;
        updateUI();
        
        if (!heardSomething) {
            showFeedback('No speech detected. Please try again.', 'warning', 2000);
        }
    };

    try {
        recognition.start();
    } catch (e) {
        console.error('Failed to start recognition', e);
        showFeedback('Could not start speech recognition.', 'warning');
    }
}
        async function checkBuddyMessages() {
            try {
                const response = await fetch('/api/buddy_messages');
                const messages = await response.json();
                if (messages.length > 0) {
                    const latestMsg = messages[messages.length - 1];
                    document.getElementById('buddy-message').textContent = latestMsg;
                    speakMessage(latestMsg);
                }
            } catch (error) {
                console.error('Error checking buddy messages:', error);
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                document.getElementById('buddy-message').textContent = 'You: ' + message;
                input.value = '';
                // send to server for unified handling (same as voice)
                fetch('/api/voice_command', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ transcript: message }) })
                    .then(r => r.json())
                    .then(data => {
                        const serverReply = data.reply || "I couldn't process that.";
                        document.getElementById('buddy-message').textContent = serverReply;
                        speakMessage(serverReply);
                        if (data.action) handleServerAction(data.action);
                    }).catch(err => {
                        console.error('sendMessage error', err);
                        document.getElementById('buddy-message').textContent = "Sorry, I couldn't reach the assistant.";
                    });
            }
        }

        function handleServerAction(action) {
    if (!action || !action.type) return;
    
    console.log('Handling action:', action);
    
    // Handle different action types
    if (action.type === 'add_task' && action.task) {
        appState.tasks.push(action.task);
        renderTasks();
        showFeedback('Task added by Buddy.', 'success', 2500);
    } else if (action.type === 'add_schedule' && action.entry) {
        showFeedback('Schedule created by Buddy.', 'success', 2500);
        loadState();
    } else if (action.type === 'suggest_dopamine' && action.suggestion) {
        document.getElementById('buddy-message').textContent = action.suggestion;
        speakMessage(action.suggestion);
    } else if (action.type === 'report_focus') {
        showFeedback(`Focus: ${action.value}%`, 'success', 2500);
    } else if (action.type === 'camera') {
        appState.cameraActive = !!action.value; 
        updateUI();
    } else if (action.type === 'setting' && action.name) {
        appState.settings[action.name] = action.value; 
        applySettings();
        showFeedback(`Setting updated: ${action.name}`, 'success', 2000);
    } else if (action.type === 'navigate' && action.view) {
        showView(action.view);
        showFeedback(`Navigated to ${action.view}`, 'success', 1500);
    } else if (action.type === 'removed_task' && action.task) {
        appState.tasks = appState.tasks.filter(t => t.id !== action.task.id);
        renderTasks();
        showFeedback(`Task "${action.task.title}" removed`, 'success', 2500);
    }
}
        function renderTasks() {
            const container = document.getElementById('tasks-container');
            if (!container) return;
            container.innerHTML = '';
            appState.tasks.forEach(task => {
                const taskHTML = `
                    <div class="task-group">
                        <h3>
                            ${task.title}
                            <span class="task-progress">${task.completed}/${task.total}</span>
                        </h3>
                        ${task.subtasks.map(subtask => `
                            <div class="subtask">
                                <div class="checkbox ${subtask.completed ? 'checked' : ''}" 
                                     onclick="toggleSubtask(${task.id}, ${subtask.id})">
                                    ${subtask.completed ? 'âœ“' : ''}
                                </div>
                                <div class="subtask-text ${subtask.completed ? 'completed' : ''}">
                                    ${subtask.text}
                                </div>
                                <div class="subtask-duration">${subtask.duration}m</div>
                                <div class="progress-mini">
                                    <div class="progress-mini-fill" style="width: ${subtask.completed ? '100' : '0'}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.innerHTML += taskHTML;
            });
        }

        async function toggleSubtask(taskId, subtaskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;
            subtask.completed = !subtask.completed;
            task.completed = task.subtasks.filter(st => st.completed).length;
            renderTasks();
            if (subtask.completed) {
                const buddyMessage = document.getElementById('buddy-message');
                buddyMessage.textContent = "Congratulations! Great job completing that subtask! ğŸ‰";
                if (task.completed === task.total) {
                    buddyMessage.textContent += " You've completed the entire task!";
                }
            }
            await fetch('/api/toggle_subtask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, subtask_id: subtaskId })
            });
        }

        async function addTask() {
            const title = prompt('Enter task title:');
            if (title) {
                const response = await fetch('/api/add_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const newTask = await response.json();
                appState.tasks.push(newTask);
                renderTasks();
            }
        }

        async function loadSchedule() {
            try {
                const dateStr = currentScheduleDate.toISOString().split('T')[0];
                const response = await fetch(`/api/schedule?date=${dateStr}`);
                const data = await response.json();
                appState.schedule = data.schedule;
                appState.bio_rhythm = data.bio_rhythm;
                renderSchedule();

                const today = new Date();
                const isToday = currentScheduleDate.toDateString() === today.toDateString();
                const formatted = currentScheduleDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('current-date').textContent = isToday ? `Today, ${formatted}` : formatted;

                const peakStr = `${data.bio_rhythm.peak_start} - ${data.bio_rhythm.peak_end}`;
                document.getElementById('peak-hours').textContent = peakStr;
                document.getElementById('peak-time-display').textContent = peakStr;

                const hour = parseInt(data.bio_rhythm.peak_start.split(':')[0]);
                const period = hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening';
                document.getElementById('bio-insight').textContent = 
                    `Based on your recent activity, you seem most alert in the ${period}. We've scheduled your hardest tasks during this window for optimal performance.`;

                if (data.daily_stats) {
                    document.getElementById('scheduled-time').textContent = data.daily_stats.scheduled;
                    document.getElementById('breaks-time').textContent = data.daily_stats.breaks;
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function prevDay() {
            currentScheduleDate.setDate(currentScheduleDate.getDate() - 1);
            loadSchedule();
        }

        function nextDay() {
            currentScheduleDate.setDate(currentScheduleDate.getDate() + 1);
            loadSchedule();
        }

        function renderSchedule() {
            const timeline = document.getElementById('schedule-timeline');
            if (!timeline) return;
            timeline.innerHTML = '';
            appState.schedule.forEach(item => {
                const energyClass = `energy-${item.energy.toLowerCase()}`;
                const itemHTML = `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-time">
                                ${item.time} (${item.duration}m)
                                <span class="energy-badge ${energyClass}">
                                    Energy: ${item.energy}
                                </span>
                            </div>
                            <strong>${item.title}</strong>
                            ${item.type === 'Deep Focus' ? '<div style="margin-top: 4px; font-size: 12px; color: #6e6e73;">ğŸ§  ' + item.type + '</div>' : ''}
                        </div>
                    </div>
                `;
                timeline.innerHTML += itemHTML;
            });
        }

        function addScheduleTask() {
            const title = prompt('Enter task to schedule:');
            if (title) {
                alert('Task will be scheduled during your next peak focus window!');
                loadSchedule();
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const analytics = await response.json();
                appState.analytics = analytics;
                renderAnalytics();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function renderAnalytics() {
            const a = appState.analytics || {};
            const deepEl = document.getElementById('deep-focus-score');
            const totalEl = document.getElementById('total-focus-time');
            const consEl = document.getElementById('consistency');
            const distEl = document.getElementById('distractions');

            if (deepEl) deepEl.textContent = (a.deep_focus_score ?? 0) + '%';
            if (totalEl) totalEl.textContent = a.total_focus_time || '0m';
            if (consEl) consEl.textContent = (a.consistency ?? 0) + '%';
            if (distEl) distEl.textContent = a.distractions ?? 0;

            // Try server-generated AI insight first (preferred)
            let usedServerInsight = false;
            try {
                const resp = await fetch('/api/ai_insight');
                if (resp.ok) {
                    const data = await resp.json();
                    const titleEl = document.getElementById('ai-insight-title');
                    const descEl = document.getElementById('ai-insight-desc');
                    if (titleEl && data.title) titleEl.textContent = data.title;
                    if (descEl && data.desc) {
                        descEl.innerHTML = data.desc;
                        descEl.dataset.dynamic = 'true';
                    }
                    usedServerInsight = true;
                }
            } catch (e) {
                // server insight failed; fall back to client-side heuristics below
            }

            // Derive a peak time if not provided
            let peakTime = a.peak_insight_time;
            try {
                if (!peakTime && Array.isArray(appState.focusHistory) && appState.focusHistory.length) {
                    const maxVal = Math.max(...appState.focusHistory);
                    const idx = appState.focusHistory.indexOf(maxVal);
                    // Map index to a friendly time-of-day bucket
                    const n = appState.focusHistory.length;
                    const part = idx < n/3 ? 'morning' : (idx < 2*n/3 ? 'afternoon' : 'evening');
                    peakTime = `around ${part}`;
                }
            } catch (e) {
                console.warn('Error computing peak time:', e);
            }

            if (peakTime) {
                const peakEl = document.getElementById('peak-insight-time');
                if (peakEl) peakEl.textContent = peakTime;
            }

            // Build a concise, actionable AI insight (client fallback if server unavailable)
            let title = 'AI Insight';
            let desc = '';

            const deepScore = a.deep_focus_score ?? null;
            const consistency = a.consistency ?? null;
            const distractions = a.distractions ?? null;

            // Human-friendly peak window
            let peakWindow = a.peak_insight_time || null;
            if (!peakWindow && peakTime) {
                if (peakTime.includes('morning')) peakWindow = '9:00 AM - 11:00 AM';
                else if (peakTime.includes('afternoon')) peakWindow = '1:00 PM - 3:00 PM';
                else if (peakTime.includes('evening')) peakWindow = '6:00 PM - 8:00 PM';
                else peakWindow = peakTime;
            }

            // Suggested task (first unfinished) or generic example
            let suggestedTask = null;
            try {
                if (Array.isArray(appState.tasks) && appState.tasks.length) {
                    const unfinished = appState.tasks.find(t => (t.completed ?? 0) < (t.total ?? 1));
                    if (unfinished) suggestedTask = unfinished.title;
                    else {
                        const mathTask = appState.tasks.find(t => /math/i.test(t.title));
                        if (mathTask) suggestedTask = mathTask.title;
                    }
                }
            } catch (e) { /* ignore */ }
            if (!suggestedTask) suggestedTask = 'challenging subjects (e.g., Math)';

            // Session length recommendation based on deep focus
            let sessionAdvice = 'Try 20â€“25 minute Pomodoro sessions to build momentum.';
            if (deepScore !== null) {
                if (deepScore >= 75) sessionAdvice = 'Schedule longer, uninterrupted sessions (60â€“90 minutes).';
                else if (deepScore >= 50) sessionAdvice = 'Aim for 45â€“60 minute focused sessions.';
            }

            // Compose description
            if (peakWindow) {
                desc += `Based on recent performance, your focus tends to peak around <strong>${peakWindow}</strong>. `;
            } else {
                desc += `Based on recent performance, we detected a recurring peak focus window. `;
            }
            desc += `We recommend scheduling your most challenging tasks â€” like <em>${suggestedTask}</em> â€” during that period. ${sessionAdvice} `;

            if (consistency !== null && consistency < 60) {
                desc += 'Your routine consistency is low; try a regular daily start time and limit context switching. ';
            }
            if (distractions !== null && distractions > 3) {
                desc += 'Reduce notifications and external interruptions during focused blocks to lower distractions.';
            }

            if (!usedServerInsight) {
                const titleEl = document.getElementById('ai-insight-title');
                const descEl = document.getElementById('ai-insight-desc');
                if (titleEl) titleEl.textContent = `${title}: ${peakWindow ? 'Peak Focus Window' : 'Personalized Tip'}`;
                if (descEl) {
                    descEl.innerHTML = desc;
                    descEl.dataset.dynamic = 'true';
                }
            }

            renderFocusChart();
            renderDistractionChart();
        }

        function renderFocusChart() {
            const ctx = document.getElementById('focus-chart');
            if (!ctx) return;

            if (window.focusChart) {
                window.focusChart.destroy();
            }

            window.focusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: appState.focusHistory.length}, (_, i) => `T${i+1}`),
                    datasets: [{
                        label: 'Focus Score',
                        data: appState.focusHistory,
                        borderColor: '#5ec4a9',
                        backgroundColor: 'rgba(94, 196, 169, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderDistractionChart() {
            const container = document.getElementById('distraction-chart');
            if (!container) return;

            const sources = appState.analytics.distraction_sources || {};
            const total = Object.values(sources).reduce((a, b) => a + b, 0);
            container.innerHTML = '';
            Object.entries(sources).forEach(([source, count]) => {
                const percentage = Math.round((count / total) * 100);
                const colors = {
                    'Phone': '#ef4444',
                    'Noise': '#f59e0b',
                    'Daydream': '#8b5cf6',
                    'Fidgeting': '#10b981'
                };
                const barHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>${source}</span>
                            <span style="font-weight: 600;">${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%; background: ${colors[source] || '#5ec4a9'};"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += barHTML;
            });
        }

        function showSettingsSection(section) {
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function toggleSetting(settingName) {
            appState.settings[settingName] = !appState.settings[settingName];
            const toggle = event.target;
            toggle.classList.toggle('active');

            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState.settings)
                });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
            // If camera access was turned off, ensure camera is disabled immediately
            if (settingName === 'camera_access' && !appState.settings.camera_access) {
                try {
                    // If camera currently active, request server to turn it off
                    if (appState.cameraActive) {
                        const resp = await fetch('/api/toggle_camera', { method: 'POST' });
                        const d = await resp.json();
                        appState.cameraActive = d.camera_active;
                    }
                } catch (err) {
                    console.error('Error disabling camera after permission change:', err);
                }
            }
            applySettings();

            // Provide user feedback about the change
            const toggleMessages = {
                'dyslexia_font': ['Font changed to dyslexic friendly', 'Dyslexic font disabled'],
                'proactive_interventions': ['Proactive interventions enabled', 'Proactive interventions disabled'],
                'camera_access': ['Camera access enabled', 'Camera access disabled'],
                'dark_mode': ['Dark mode enabled', 'Light mode enabled'],
                'color_blind_mode': ['Color-blind mode enabled', 'Color-blind mode disabled'],
                'hide_sidebar': ['Sidebar hidden', 'Sidebar shown']
            };
            if (toggleMessages[settingName]) {
                const msg = appState.settings[settingName] ? toggleMessages[settingName][0] : toggleMessages[settingName][1];
                showFeedback(msg);
            }
        }

        async function updateSetting(settingName, value) {
    appState.settings[settingName] = value;

    try {
        await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appState.settings)
        });
    } catch (error) {
        console.error('Save error:', error);
    }

    applySettings();
    
    // If language changed, apply it
    if (settingName === 'language') {
        applyLanguage();
        showFeedback(`Language changed to ${value}`, 'success', 2500);
    }
    
    // Feedback for other settings
    const feedbackMessages = {
        'color_contrast': (v) => `Color contrast set to ${v}`,
        'buddy_persona': (v) => `Buddy persona set to ${v}`,
        'dark_mode': (v) => v ? 'Dark mode enabled' : 'Dark mode disabled',
        'dyslexia_font': (v) => v ? 'Dyslexia font enabled' : 'Dyslexia font disabled',
        'color_blind_mode': (v) => v ? 'Color blind mode enabled' : 'Color blind mode disabled',
        'hide_sidebar': (v) => v ? 'Sidebar hidden' : 'Sidebar shown',
        'proactive_interventions': (v) => v ? 'Proactive interventions enabled' : 'Proactive interventions disabled',
        'camera_access': (v) => v ? 'Camera access enabled' : 'Camera access disabled'
    };
    
    if (feedbackMessages[settingName]) {
        showFeedback(feedbackMessages[settingName](value));
    }
}

        function applySettings() {
                    // Dyslexia font
                    document.body.classList.toggle('dyslexia-font', appState.settings.dyslexia_font);

                    // Dark mode
                    document.body.classList.toggle('dark-mode', !!appState.settings.dark_mode);

                    // Color-blind mode
                    document.body.classList.toggle('color-blind', !!appState.settings.color_blind_mode);

                    // Hide/Show sidebar
                    const sidebarEl = document.querySelector('.sidebar');
                    if (sidebarEl) sidebarEl.classList.toggle('hidden', !!appState.settings.hide_sidebar);

                    // Contrast levels
                    document.body.classList.remove('high-contrast', 'maximum-contrast');
                    if (appState.settings.color_contrast === 'High') {
                        document.body.classList.add('high-contrast');
                    } else if (appState.settings.color_contrast === 'Maximum') {
                        document.body.classList.add('maximum-contrast');
                    }

                    // Sync toggle controls
                    const safeToggle = (id, val) => { const el = document.getElementById(id); if (el) el.classList.toggle('active', !!val); };
                    safeToggle('dyslexia-toggle', appState.settings.dyslexia_font);
                    safeToggle('intervention-toggle', appState.settings.proactive_interventions);
                    safeToggle('camera-access-toggle', appState.settings.camera_access);
                    safeToggle('darkmode-toggle', appState.settings.dark_mode);
                    safeToggle('colorblind-toggle', appState.settings.color_blind_mode);
                    safeToggle('sidebar-toggle', appState.settings.hide_sidebar);

                    // Sync selects
                    const cs = document.getElementById('contrast-select'); if (cs) cs.value = appState.settings.color_contrast || 'Standard';
                    const ps = document.getElementById('persona-select'); if (ps) ps.value = appState.settings.buddy_persona || 'Friendly Peer';
                    const ls = document.getElementById('language-select'); if (ls) ls.value = appState.settings.language || 'English';

                    applyLanguage();
        }

        function triggerBreak(activity) {
            const messages = {
                'jumping-jacks': "Great choice! Do 5 jumping jacks and come back energized!",
                'water': "Perfect! Stay hydrated. I'll be here when you get back!",
                'pet': "Aww, go give your cat some love! See you in a minute!",
                'stretch': "Good idea! Stretch those muscles. Your body will thank you!"
            };

            const message = messages[activity] || "Nice! Taking a quick break is smart. See you soon!";
            document.getElementById('buddy-message').textContent = message;
            speakMessage(message);
        }

        window.onload = init;
    </script>
</body>
</html>
