<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow - ADHD Study Assistant</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=OpenDyslexic&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafb 0%, #f0f4f8 100%);
            color: #0f1419;
            letter-spacing: 0.3px;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        #focus-chart {
            height: 350px !important;
            width: 100% !important;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0, 0, 0, 0.06);
        }

        .logo {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #5ec4a9 0%, #3ba892 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 32px;
            letter-spacing: -0.5px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nav-icon svg { width: 18px; height: 18px; fill: currentColor; display: block; }

        .settings-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: inherit;
        }

        .settings-icon svg { width: 16px; height: 16px; fill: currentColor; display: block; }

        .nav-item:hover {
            background: rgba(94, 196, 169, 0.08);
            color: #5ec4a9;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.15) 0%, rgba(94, 196, 169, 0.08) 100%);
            color: #5ec4a9;
            border-left: 3px solid #5ec4a9;
            padding-left: 13px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 40px;
            margin-bottom: 8px;
            font-weight: 700;
            color: #0f1419;
            letter-spacing: -0.5px;
        }

        .header p {
            color: #64748b;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
        }

        .privacy-badge {
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(94, 196, 169, 0.1);
            color: #5ec4a9;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 16px;
            border: 1px solid rgba(94, 196, 169, 0.2);
        }

        /* Dashboard Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: rgba(94, 196, 169, 0.2);
        }

        /* Focus Status */
        .focus-status {
            margin-bottom: 24px;
        }

        .focus-status h3 {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .focus-meter {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .focus-meter span {
            font-size: 36px;
            font-weight: 700;
            color: #0f1419;
        }

        .progress-bar {
            flex: 1;
            height: 12px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #5ec4a9, #98d8c8);
            border-radius: 6px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 12px rgba(94, 196, 169, 0.4);
        }
        }

        .webcam-status {
            font-size: 12px;
            color: #6e6e73;
        }

        /* Focus Buddy */
        .focus-buddy {
            margin-bottom: 24px;
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.06), rgba(94, 196, 169, 0.02));
        }

        .buddy-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Compact Focus Buddy for sidebar */
        .focus-buddy.compact .buddy-avatar {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }
        .focus-buddy.compact .buddy-info h4 {
            font-size: 15px;
            font-weight: 600;
        }
        .focus-buddy.compact .buddy-info p {
            font-size: 11px;
            color: #64748b;
        }
        .focus-buddy.compact .language-badge {
            padding: 3px 10px;
            font-size: 11px;
            border-radius: 6px;
        }
        .focus-buddy.compact .buddy-message {
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
        }
        .focus-buddy.compact .mic-button {
            width: 36px;
            height: 36px;
            flex: 0 0 36px;
        }
        .focus-buddy.compact .chat-input input {
            padding: 10px 12px;
            border-radius: 20px;
            font-size: 13px;
            min-width: 0;
            flex: 1 1 auto;
        }
        .focus-buddy.compact .chat-input { gap: 8px; }

        .buddy-avatar {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .buddy-info h4 {
            font-size: 17px;
            font-weight: 700;
            color: #0f1419;
        }

        .buddy-info p {
            font-size: 12px;
            color: #64748b;
        }

        .language-badge {
            margin-left: auto;
            padding: 5px 12px;
            background: rgba(94, 196, 169, 0.08);
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #5ec4a9;
            border: 1px solid rgba(94, 196, 169, 0.15);
        }

        .buddy-message {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.08), rgba(94, 196, 169, 0.03));
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            line-height: 1.6;
            border: 1px solid rgba(94, 196, 169, 0.15);
            color: #1d1d1f;
        }

        .chat-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .chat-input input:focus {
            outline: none;
            border-color: #5ec4a9;
            box-shadow: 0 0 0 4px rgba(94, 196, 169, 0.15);
            background: white;
        }
        }

        .mic-button {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(94, 196, 169, 0.2);
        }

        .mic-button:hover {
            box-shadow: 0 4px 16px rgba(94, 196, 169, 0.3);
            transform: translateY(-2px);
        }

        .mic-button.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.5);
        }

        /* Pin sidebar Focus Buddy to bottom when visible */
        #sidebar-focus-buddy { margin-top: auto; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Dopamine Menu */
        .dopamine-menu {
            margin-top: 24px;
        }

        .dopamine-menu h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            color: #d97706;
        }

        .dopamine-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .dopamine-item {
            padding: 14px;
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.08), rgba(217, 119, 6, 0.04));
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(217, 119, 6, 0.15);
        }

        .dopamine-item:hover {
            border-color: #d97706;
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.12), rgba(217, 119, 6, 0.08));
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.15);
        }
        }

        /* Tasks */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .tasks-header h2 {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chunking-badge {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05));
            color: #b45309;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(217, 119, 6, 0.2);
            letter-spacing: 0.3px;
        }

        .add-task-btn {
            color: #5ec4a9;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(94, 196, 169, 0.05);
            border: 1px solid rgba(94, 196, 169, 0.1);
        }

        .add-task-btn:hover {
            background: rgba(94, 196, 169, 0.12);
            box-shadow: 0 4px 12px rgba(94, 196, 169, 0.15);
            transform: translateY(-2px);
        }

        #add-schedule-btn {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.1) 0%, rgba(152, 216, 200, 0.05) 100%) !important;
            border: 2px solid rgba(94, 196, 169, 0.3) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #5ec4a9;
            font-weight: 600;
            border-radius: 8px !important;
        }

        #add-schedule-btn:hover {
            border-color: #5ec4a9 !important;
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.15) 0%, rgba(152, 216, 200, 0.1) 100%) !important;
            box-shadow: 0 6px 16px rgba(94, 196, 169, 0.25) !important;
            transform: translateY(-2px) !important;
        }

        #add-schedule-btn svg {
            color: #5ec4a9;
        }

        .task-group {
            margin-bottom: 24px;
        }

        .task-group h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-progress {
            font-size: 12px;
            color: #6e6e73;
        }

        .subtask {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .subtask:hover {
            background: rgba(94, 196, 169, 0.05);
            border-color: rgba(94, 196, 169, 0.2);
            box-shadow: 0 2px 8px rgba(94, 196, 169, 0.1);
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(100, 116, 139, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .checkbox:hover {
            border-color: rgba(94, 196, 169, 0.5);
        }

        .checkbox.checked {
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            border-color: #5ec4a9;
            box-shadow: 0 2px 6px rgba(94, 196, 169, 0.3);
        }

        .subtask-text {
            flex: 1;
        }

        .subtask-text.completed {
            text-decoration: line-through;
            color: #6e6e73;
        }

        .subtask-duration {
            color: #6e6e73;
            font-size: 12px;
        }

        .progress-mini {
            width: 60px;
            height: 4px;
            background: #e8e8ed;
            border-radius: 2px;
        }

        .progress-mini-fill {
            height: 100%;
            background: #5ec4a9;
            border-radius: 2px;
        }

        /* Activity Insights */
        .activity-insights {
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 16px;
            border: 1px solid rgba(94, 196, 169, 0.2);
            box-shadow: 0 4px 12px rgba(94, 196, 169, 0.08);
        }

        .activity-insights h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #5ec4a9;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .insights-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.08), rgba(94, 196, 169, 0.03));
            padding: 14px 12px;
            border-radius: 12px;
            border: 1.5px solid rgba(94, 196, 169, 0.2);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover {
            border-color: #5ec4a9;
            box-shadow: 0 4px 12px rgba(94, 196, 169, 0.2);
            transform: translateY(-4px);
        }

        .metric-value {
            font-size: 22px;
            font-weight: 800;
            color: #5ec4a9;
            display: block;
            margin-bottom: 6px;
        }

        .metric-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 600;
        }

        .insights-tip {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.08), rgba(94, 196, 169, 0.03));
            border-left: 4px solid #5ec4a9;
            padding: 14px 14px;
            border-radius: 8px;
            font-size: 13px;
            color: #1d1d1f;
            line-height: 1.6;
            border: 1px solid rgba(94, 196, 169, 0.15);
            border-left-width: 4px;
        }

        /* Schedule View */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .date-nav {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .date-nav button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #64748b;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .date-nav button:hover {
            color: #5ec4a9;
        }

        .bio-rhythm-card {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.08), rgba(94, 196, 169, 0.03));
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid rgba(94, 196, 169, 0.15);
        }

        .timeline {
            margin-top: 24px;
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            position: relative;
        }

        .timeline-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            margin-top: 3px;
            flex-shrink: 0;
            box-shadow: 0 0 8px rgba(94, 196, 169, 0.4);
        }

        .timeline-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .timeline-content:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .timeline-time {
            color: #64748b;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .energy-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .energy-high {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .energy-medium {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05));
            color: #b45309;
            border: 1px solid rgba(217, 119, 6, 0.2);
        }

        .energy-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Analytics View */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 28px 24px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.12), rgba(94, 196, 169, 0.06));
        }

        .stat-icon-focus { background: linear-gradient(135deg, rgba(94, 196, 169, 0.15), rgba(94, 196, 169, 0.08)); }
        .stat-icon-time { background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.08)); }
        .stat-icon-consistency { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08)); }
        .stat-icon-distractions { background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.08)); }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #0f1419;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 6px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 28px;
            border-radius: 14px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .ai-insight-card {
            background: linear-gradient(135deg, rgba(94, 196, 169, 0.08), rgba(144, 202, 249, 0.08));
            margin-top: 24px;
            border: 1px solid rgba(94, 196, 169, 0.2);
            border-radius: 12px;
            padding: 20px;
        }

        /* Settings View */
        .settings-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 32px;
        }

        .settings-nav {
            background: white;
            padding: 16px;
            border-radius: 12px;
            height: fit-content;
        }

        .settings-nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1d1d1f;
        }

        .settings-nav-item:hover {
            background: #f5f5f7;
        }

        .settings-nav-item.active {
            background: #e8f5f2;
            color: #5ec4a9;
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 32px;
            border-radius: 14px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .settings-group {
            margin-bottom: 32px;
        }

        .settings-group h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #0f1419;
        }

        .settings-group p {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .toggle-switch {
            width: 48px;
            height: 28px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            box-shadow: 0 0 8px rgba(94, 196, 169, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .privacy-card {
            background: #e8f5f2;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        select {
            padding: 10px 14px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        select:hover {
            border-color: rgba(94, 196, 169, 0.4);
        }
        
        select:focus {
            outline: none;
            border-color: #5ec4a9;
            box-shadow: 0 0 0 4px rgba(94, 196, 169, 0.15);
        }

        /* Video Feed */
        .video-feed {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .video-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hidden {
            display: none;
        }

        .mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings feedback banner */
        #settings-feedback {
            margin: 12px 0 0 0;
            padding: 10px 14px;
            border-radius: 10px;
            display: inline-block;
            font-size: 14px;
            box-shadow: 0 4px 16px rgba(2,6,23,0.08);
            transition: transform 180ms ease, opacity 180ms ease;
            opacity: 0.0;
            transform: translateY(-6px);
        }
        #settings-feedback.visible { opacity: 1.0; transform: translateY(0); }
        #settings-feedback.success { background: #e6ffed; color: #065f46; }
        #settings-feedback.warning { background: #fff4e5; color: #7a4a00; }

        /* Dynamic Settings Styles */
        body.dyslexia-font {
            font-family: 'OpenDyslexic', 'Dyslexie', Arial, Helvetica, sans-serif !important;
            /* Make dyslexic mode more visually distinct even if the font file isn't available */
            font-weight: 600 !important;
            letter-spacing: 0.4px !important;
            word-spacing: 1px !important;
            line-height: 1.6 !important;
            font-size: 1.02em !important;
            text-rendering: optimizeLegibility !important;
        }

        /* Dark mode */
        body.dark-mode {
            background: #0b1220;
            color: #e6eef6;
        }
        body.dark-mode .card,
        body.dark-mode .settings-section,
        body.dark-mode .settings-nav,
        body.dark-mode .chart-container,
        body.dark-mode .activity-insights,
        body.dark-mode .dopamine-menu,
        body.dark-mode .focus-buddy,
        body.dark-mode .tasks-header,
        body.dark-mode .task-group,
        body.dark-mode .stat-card,
        body.dark-mode .ai-insight-card,
        body.dark-mode .bio-rhythm-card,
        body.dark-mode .privacy-card {
            background: #0f1724;
            box-shadow: none;
            color: #e6eef6;
        }
        body.dark-mode .sidebar {
            background: #071029;
            color: #cfe6ff;
        }
        body.dark-mode .nav-item { color: #bcd7ef; }
        body.dark-mode .main-content { background: transparent; }
        body.dark-mode .nav-item.active { background: transparent; color: #9fe3c9; }
        body.dark-mode .privacy-badge { background: rgba(94,196,169,0.08); color: #9fe3c9; }
        body.dark-mode .mic-button { background: #154046; color: #d1f7ef; }
        body.dark-mode .mic-button.active { background: #b91c1c; }
        body.dark-mode .add-task-btn { color: #9fe3c9; }
        body.dark-mode .toggle-switch { background: #25303a; }
        body.dark-mode .toggle-switch::after { background: #f3f7f9; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #071226; color: #e6eef6; border: 1px solid #21303f; }
        body.dark-mode .progress-bar { background: #071226; }
        body.dark-mode .progress-fill { background: linear-gradient(90deg,#2dd4bf,#7dd3fc); }
        body.dark-mode .dopamine-item { background: #071f2b; border: 1px solid #12323f; color: #d1f7ff; }
        body.dark-mode .subtask { background: #071226; color: #dbeef6; }
        body.dark-mode .chat-input input { background: #071226; color: #e6eef6; border-color: #21303f; }
        body.dark-mode .language-badge { background: #0f1b2f; color: #cde7ff; border: 1px solid #1f2a3a; }
        body.dark-mode .buddy-message { background: #0f1b2f; color: #dbeef6; border: 1px solid #1f2a3a; }
        body.dark-mode .stat-icon { background: #16233b !important; color: #9fe3c9; }
        body.dark-mode .stat-icon-focus { background: #123b32 !important; }
        body.dark-mode .stat-icon-time { background: #1e2345 !important; }
        body.dark-mode .stat-icon-consistency { background: #122d42 !important; }
        body.dark-mode .stat-icon-distractions { background: #3a2617 !important; }
        body.dark-mode .stat-label { color: #bcd7ef; }
        body.dark-mode .bio-rhythm-card { background: linear-gradient(135deg, #0f1b2f 0%, #0b1220 100%); border: 1px solid #1e2a3a; }
        body.dark-mode .ai-insight-card { background: linear-gradient(135deg, #0f1724 0%, #0b1220 100%); border: 1px solid #1e2a3a; }
        body.dark-mode .privacy-card { background: #0f1b2f; border: 1px solid #1f2a3a; }
        body.dark-mode #bio-insight { color: #bcd7ef; }
        body.dark-mode #local-processing-desc { color: #bcd7ef; }
        body.dark-mode .settings-nav { background: #0f1724; border: 1px solid #1f2a3a; }
        body.dark-mode .settings-nav-item { color: #cfe6ff; }
        body.dark-mode .settings-nav-item:hover { background: #0f1b2f; }
        body.dark-mode .settings-nav-item.active { background: #123b32; color: #9fe3c9; }
        body.dark-mode .settings-icon { color: inherit; }
        body.dark-mode .settings-label { color: inherit; }

        /* Color-blind friendly adjustments (high contrast but colorblind palette) */
        body.color-blind .dopamine-item { background: #e0f2ff; border-color: #0077b6; }
        body.color-blind .progress-fill { background: #0077b6; }

        /* Hide sidebar */
        .sidebar.hidden { width: 0; padding: 0; overflow: hidden; display: none; }

        /* Toolbar dark toggle */
        .toolbar-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid rgba(0,0,0,0.06);
            cursor: pointer;
            color: inherit;
            margin-left: 12px;
        }
        .toolbar-button.active { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }

        /* Modal Backdrop */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            z-index: 999;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-backdrop.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Add Task Modal */
        #task-modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.16);
            animation: slideUp 0.3s ease-out;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        #task-modal h2 {
            font-size: 24px;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        #task-modal .modal-subtitle {
            color: #6e6e73;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-size: 14px;
        }

        .modal-form-group input,
        .modal-form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.8);
        }

        .modal-form-group input:focus,
        .modal-form-group textarea:focus {
            outline: none;
            border-color: #5ec4a9;
            box-shadow: 0 0 0 4px rgba(94, 196, 169, 0.15);
            background: white;
        }

        .modal-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-difficulty {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .difficulty-option {
            flex: 1;
            padding: 12px 10px;
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
        }

        .difficulty-option:hover {
            border-color: rgba(94, 196, 169, 0.5);
            background: rgba(94, 196, 169, 0.06);
            transform: translateY(-2px);
        }

        .difficulty-option.selected {
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            color: white;
            border-color: #5ec4a9;
            box-shadow: 0 4px 12px rgba(94, 196, 169, 0.3);
            transform: translateY(-2px);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #5ec4a9, #3ba892);
            color: white;
            box-shadow: 0 4px 12px rgba(94, 196, 169, 0.2);
        }

        .modal-btn-primary:hover {
            box-shadow: 0 6px 20px rgba(94, 196, 169, 0.3);
            transform: translateY(-2px);
        }

        .modal-btn-secondary {
            background: rgba(0, 0, 0, 0.05);
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .modal-btn-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">FOCUSFLOW</div>
            <nav>
                <div class="nav-item active" id="nav-dashboard" onclick="showView('dashboard')">
                    <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5Z"/></svg>
                    </span>
                    <span class="nav-label" id="nav-dashboard-label">Dashboard</span>
                </div>
                <div class="nav-item" id="nav-schedule" onclick="showView('schedule')">
                    <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24"><path d="M7 2v2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7Zm12 6H5v11h14V8Z"/></svg>
                    </span>
                    <span class="nav-label" id="nav-schedule-label">Schedule</span>
                </div>
                <div class="nav-item" id="nav-analytics" onclick="showView('analytics')">
                    <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24"><path d="M5 3a1 1 0 0 1 1 1v14h12a1 1 0 1 1 0 2H5a2 2 0 0 1-2-2V4a1 1 0 0 1 1-1Zm14 2a1 1 0 0 1 1 1v11a1 1 0 1 1-2 0V6h-4a1 1 0 0 1 0-2h5Zm-4 4a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0v-7a1 1 0 0 1 1-1Zm-4 2a1 1 0 0 1 1 1v5a1 1 0 1 1-2 0v-5a1 1 0 0 1 1-1Zm-4 2a1 1 0 0 1 1 1v3a1 1 0 1 1-2 0v-3a1 1 0 0 1 1-1Z"/></svg>
                    </span>
                    <span class="nav-label" id="nav-analytics-label">Analytics</span>
                </div>
                <div class="nav-item" id="nav-settings" onclick="showView('settings')">
                    <span class="nav-icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm0-3a1 1 0 0 1 .95.68l.5 1.54a6.04 6.04 0 0 1 1.58.92l1.62-.47a1 1 0 0 1 1.2.65l.5 1.54a1 1 0 0 1-.24 1.02l-1.22 1.2c.07.34.11.69.11 1.06s-.04.72-.11 1.06l1.22 1.2a1 1 0 0 1 .24 1.02l-.5 1.54a1 1 0 0 1-1.2.65l-1.62-.47a6.04 6.04 0 0 1-1.58.92l-.5 1.54a1 1 0 0 1-.95.68h-1a1 1 0 0 1-.95-.68l-.5-1.54a6.04 6.04 0 0 1-1.58-.92l-1.62.47a1 1 0 0 1-1.2-.65l-.5-1.54a1 1 0 0 1 .24-1.02l1.22-1.2A5.98 5.98 0 0 1 6 12c0-.36.04-.72.11-1.06l-1.22-1.2a1 1 0 0 1-.24-1.02l.5-1.54a1 1 0 0 1 1.2-.65l1.62.47c.48-.37 1-.69 1.58-.92l.5-1.54A1 1 0 0 1 11 5.5h1Z"/></svg>
                    </span>
                    <span class="nav-label" id="nav-settings-label">Settings</span>
                </div>
            </nav>

            <!-- Focus Buddy (shown in sidebar for non-dashboard tabs) -->
            <div class="card focus-buddy compact" id="sidebar-focus-buddy" style="display: none;">
                <div class="buddy-header">
                    <div class="buddy-avatar" aria-hidden="true">ü§ñ</div>
                    <div class="buddy-info">
                        <h4 id="focus-buddy-title">Focus Buddy</h4>
                        <p id="buddy-help-text">ALWAYS HERE TO HELP</p>
                    </div>
                    <div class="language-badge" id="current-lang-badge">English</div>
                </div>

                <div class="buddy-message" id="buddy-message">
                    Hi Friend! I noticed you've been staring at the wall. Let's finish this paragraph together?
                </div>

                <div class="chat-input">
                    <button class="mic-button" id="mic-toggle" onclick="startVoiceCapture()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block;"><path d="M12 14c1.66 0 3-1.34 3-3V6a3 3 0 1 0-6 0v5c0 1.66 1.34 3 3 3Zm5-3h-1a5 5 0 1 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 17 11Z"/></svg></button>
                    <input type="text" placeholder="Type or speak to Buddy..." id="chat-input" onkeypress="handleChatInput(event)">
                    <button style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="sendMessage()"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="view">
                <div class="header">
                    <h1 id="greeting-prefix">Good <span id="greeting"></span>, Friend</h1>
                    <p id="ready-text">Ready to conquer your tasks today?</p>
                    <div class="privacy-badge" id="privacy-badge" style="display: none;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>Privacy Mode: Local Processing Only
                    </div>
                    <!-- camera-notice removed; feedback displayed in Settings page -->
                </div>

                <div class="dashboard-grid">
                    <div>
                        <!-- Focus Status -->
                        <div class="card focus-status">
                            <h3 id="current-focus-label">CURRENT FOCUS</h3>
                            <div class="focus-meter">
                                <span id="focus-percentage">0%</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="focus-bar" style="width:0%"></div>
                                </div>
                            </div>

                            <p class="webcam-status">
                                <span id="webcam-status">Webcam inactive</span>. Monitoring gaze & posture.
                            </p>
                            <button class="mic-button" id="camera-toggle" onclick="toggleCamera()">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block;"><path d="M20 5h-3.17l-1.41-1.41A2 2 0 0 0 14 3H10a2 2 0 0 0-1.41.59L7.17 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm-8 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
                            </button>
                            <div id="video-container" class="video-feed hidden">
                                <img id="video-feed" src="/video_feed" alt="Video Feed">
                            </div>
                        </div>

                        <!-- Focus Buddy (shown only on Dashboard, above Dopamine Menu) -->
                        <div id="dashboard-focus-buddy" class="card focus-buddy" style="margin-top: 24px;">
                            <div class="buddy-header">
                                <div class="buddy-avatar" aria-hidden="true">ü§ñ</div>
                                <div class="buddy-info">
                                    <h4 id="focus-buddy-title-db">Focus Buddy</h4>
                                    <p id="buddy-help-text-db">ALWAYS HERE TO HELP</p>
                                </div>
                                <div class="language-badge" id="current-lang-badge-db">English</div>
                            </div>

                            <div class="buddy-message" id="buddy-message-db">
                                Hi Friend! I noticed you've been staring at the wall. Let's finish this paragraph together?
                            </div>

                            <div class="chat-input">
                                <button class="mic-button" id="mic-toggle-db" onclick="startVoiceCapture()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block;"><path d="M12 14c1.66 0 3-1.34 3-3V6a3 3 0 1 0-6 0v5c0 1.66 1.34 3 3 3Zm5-3h-1a5 5 0 1 1-10 0H5a7 7 0 0 0 6 6.92V21h2v-3.08A7 7 0 0 0 17 11Z"/></svg></button>
                                <input type="text" placeholder="Type or speak to Buddy..." id="chat-input-db" onkeypress="handleChatInput(event)">
                                <button style="background: none; border: none; font-size: 20px; cursor: pointer;" onclick="sendMessage()"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                            </div>
                        </div>

                        <!-- Dopamine Menu -->
                        <div class="card dopamine-menu">
                            <h4 id="dopamine-menu-title"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-1-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg> Dopamine Menu</h4>
                            <div class="dopamine-grid">
                                <div class="dopamine-item" onclick="triggerBreak('jumping-jacks')">5 Jumping Jacks</div>
                                <div class="dopamine-item" onclick="triggerBreak('water')">Drink Water</div>
                                <div class="dopamine-item" onclick="triggerBreak('pet')">Pet the cat</div>
                                <div class="dopamine-item" onclick="triggerBreak('stretch')">Stretch</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="card">
                        <div class="tasks-header">
                            <h2 id="tasks-title">Tasks <span class="chunking-badge" id="chunking-badge">Chunking Active</span></h2>
                            <div class="add-task-btn" id="add-task-btn" onclick="addTask()"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Task</div>
                        </div>

                        <div id="tasks-container"></div>

                        <div class="activity-insights">
                            <h4 id="activity-insights-title"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block; margin-right: 8px;"><path d="M3.5 9.75h3v10.5h-3V9.75zm9-5h3v15.5h-3V4.75zm4.5 7h3v8.5h-3v-8.5z"/></svg>Activity Insights</h4>
                            <div id="activity-insights-content" class="insights-metrics"></div>
                            <div class="insights-tip" id="activity-insights-tip">You're making great progress! Keep the momentum going.</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Schedule View -->
            <div id="schedule-view" class="view hidden">
                <div class="header">
                    <h1 id="schedule-title">Your Bio-Rhythm Schedule</h1>
                    <p id="schedule-desc">Optimized for your peak focus hours (<span id="peak-hours"></span>)</p>
                </div>

                <div class="schedule-header">
                    <h2 id="timeline-title"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg>Timeline</h2>
                    <div class="date-nav">
                        <button onclick="prevDay()">‚Üê</button>
                        <span id="current-date">Today, Dec 17</span>
                        <button onclick="nextDay()">‚Üí</button>
                    </div>
                </div>

                <div class="bio-rhythm-card">
                    <h3 id="bio-rhythm-title"><svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>BIO-RHYTHM INSIGHT</h3>
                    <h2 id="peak-focus-title">Peak Focus Time</h2>
                    <p id="peak-time-display"></p>
                    <p id="bio-insight" style="margin-top: 12px; color: #6e6e73;">
                        Based on your activity yesterday, you seem most alert in the late morning.
                        We've scheduled your hardest tasks (Math, HCI) during this window.
                    </p>
                </div>

                <div class="card">
                    <div class="timeline" id="schedule-timeline"></div>
                    
                    <div id="add-schedule-btn" style="text-align: center; padding: 24px; border-radius: 12px; cursor: pointer;" onclick="addScheduleTask()">\n                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="display: inline-block; margin-right: 8px; vertical-align: middle;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg><span id="add-schedule-btn-text">Add Task to Schedule</span>\n                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 id="daily-stats-title">DAILY STATS</h3>
                    <div style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span id="scheduled-label">Scheduled</span>
                            <span style="font-weight: 600;" id="scheduled-time">4h 30m</span>
                        </div>
                        <div class="progress-bar" style="margin-bottom: 16px;">
                            <div class="progress-fill" style="width: 75%"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between;">
                            <span id="breaks-label">Breaks</span>
                            <span style="font-weight: 600;" id="breaks-time">45m</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 30%; background: #fbbf24;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analytics-view" class="view hidden">
                <div class="header">
                    <h1 id="analytics-title">Weekly Insights</h1>
                    <p id="analytics-desc">Understanding your focus patterns to optimize your study routine.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-icon-focus"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 4a4 4 0 0 0-4 4v1a3 3 0 0 0 0 6v1a4 4 0 0 0 4 4h1a3 3 0 0 0 6 0h1a4 4 0 0 0 4-4v-1a3 3 0 0 0 0-6V8a4 4 0 0 0-4-4h-1a3 3 0 0 0-6 0H8z"/></svg></div>
                        <div class="stat-value" id="deep-focus-score">78%</div>
                        <div class="stat-label" id="deep-focus-label">Deep Focus Score</div>
                        <div class="stat-change positive">+5%</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon stat-icon-time"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zm0 12c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/></svg></div>
                        <div class="stat-value" id="total-focus-time">4h 12m</div>
                        <div class="stat-label" id="total-focus-label">Total Focus Time</div>
                        <div class="stat-change positive">+30m</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon stat-icon-consistency"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></div>
                        <div class="stat-value" id="consistency">85%</div>
                        <div class="stat-label" id="consistency-label">Consistency</div>
                        <div class="stat-change positive">Stable</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon stat-icon-distractions"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div>
                        <div class="stat-value" id="distractions">12</div>
                        <div class="stat-label" id="distractions-label">Distractions</div>
                        <div class="stat-change negative">-3</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 id="focus-rhythm-title">Focus Rhythm</h3>
                    <p style="color: #6e6e73; margin-bottom: 24px;" id="focus-rhythm-desc">Your attention levels throughout the day</p>
                    <canvas id="focus-chart"></canvas>
                </div>

                <div class="chart-container">
                    <h3 id="distraction-title">Distraction Sources</h3>
                    <p style="color: #6e6e73; margin-bottom: 24px;" id="distraction-desc">What broke your flow today?</p>
                    <div id="distraction-chart"></div>
                </div>

                <div class="card ai-insight-card">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px;"><svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor"><path d="M8 4a4 4 0 0 0-4 4v1a3 3 0 0 0 0 6v1a4 4 0 0 0 4 4h1a3 3 0 0 0 6 0h1a4 4 0 0 0 4-4v-1a3 3 0 0 0 0-6V8a4 4 0 0 0-4-4h-1a3 3 0 0 0-6 0H8z"/></svg></div>
                        <div>
                            <h3 id="ai-insight-title">AI Insight: Peak Performance</h3>
                            <p style="margin-top: 8px;" id="ai-insight-desc">Friend, your focus consistently peaks between <strong id="peak-insight-time">10:00 AM and 11:30 AM</strong>. We recommend scheduling your most challenging subjects (like Math) during this window for maximum retention.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view hidden">
                <div class="header">
                    <h1 id="settings-title">Settings & Preferences</h1>
                    <p id="settings-desc">Customize your FocusFlow experience to match your needs.</p>
                </div>

                <div class="settings-layout">
                    <div class="settings-nav">
                        <div class="settings-nav-item active" id="accessibility-id" onclick="showSettingsSection('accessibility', event)">
                            <span class="settings-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4Zm-1.5 5h3a1 1 0 0 1 .96.73l.92 3.27H18a1 1 0 1 1 0 2h-2.18l-.68 2.45 1.33 4.41a1 1 0 0 1-1.9.58L12 16.75l-2.57 3.69a1 1 0 1 1-1.9-.58l1.33-4.4-.68-2.46H6a1 1 0 0 1 0-2h2.62l.92-3.27A1 1 0 0 1 10.5 7Z"/></svg>
                            </span>
                            <span class="settings-label" id="accessibility-label">Accessibility</span>
                        </div>
                        <div class="settings-nav-item" id="focusbuddy-id" onclick="showSettingsSection('buddy', event)">
                            <span class="settings-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24"><path d="M7 4a5 5 0 0 1 10 0v1h1a2 2 0 0 1 2 2v3a5 5 0 0 1-4 4.9V17a2 2 0 0 1-2 2v1a1 1 0 1 1-2 0v-1h-1v1a1 1 0 1 1-2 0v-1a2 2 0 0 1-2-2v-2.1A5 5 0 0 1 4 10V7a2 2 0 0 1 2-2h1V4Zm2 1h6V4a3 3 0 1 0-6 0v1Zm-3 3v2a3 3 0 1 0 6 0V8H6Zm8 0v2a3 3 0 1 0 6 0V8h-6Z"/></svg>
                            </span>
                            <span class="settings-label" id="focusbuddy-label">Focus Buddy</span>
                        </div>
                        <div class="settings-nav-item" id="privacy-id" onclick="showSettingsSection('privacy', event)">
                            <span class="settings-icon" aria-hidden="true">
                                <svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v2h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h1V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v2h6V7a3 3 0 0 0-3-3Zm7 8H5v7h14v-7Z"/></svg>
                            </span>
                            <span class="settings-label" id="privacy-label">Privacy</span>
                        </div>
                    </div>

                    <div class="settings-section" id="settings-content">
                        <div id="settings-feedback" class="hidden" role="status" aria-live="polite"></div>
                        <div id="accessibility-settings">
                            <div class="settings-group" id="a&s-id">
                                <h3><span class="settings-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4Zm-1.5 5h3a1 1 0 0 1 .96.73l.92 3.27H18a1 1 0 1 1 0 2h-2.18l-.68 2.45 1.33 4.41a1 1 0 0 1-1.9.58L12 16.75l-2.57 3.69a1 1 0 1 1-1.9-.58l1.33-4.4-.68-2.46H6a1 1 0 0 1 0-2h2.62l.92-3.27A1 1 0 0 1 10.5 7Z"/></svg></span> Accessibility & Sensory</h3>
                                <p>Adjust the interface for your comfort.</p>

                                <div class="setting-item">
                                    <div>
                                        <strong id="dyslexia-label">Dyslexia Friendly Font</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Switches text to OpenDyslexic or similar accessible font.
                                        </p>
                                    </div>
                                            <div class="toggle-switch" id="dyslexia-toggle" onclick="toggleSetting('dyslexia_font')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="darkmode-label">Dark Mode</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Switch to a dark theme to reduce glare.</p>
                                            </div>
                                            <div class="toggle-switch" id="darkmode-toggle" onclick="toggleSetting('dark_mode')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="colorblind-label">Color Blind Mode</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Use a color-blind friendly palette for key UI elements.</p>
                                            </div>
                                            <div class="toggle-switch" id="colorblind-toggle" onclick="toggleSetting('color_blind_mode')"></div>
                                        </div>

                                        <div class="setting-item">
                                            <div>
                                                <strong id="sidebar-label">Hide Sidebar</strong>
                                                <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">Collapse the left navigation to focus on content.</p>
                                            </div>
                                            <div class="toggle-switch" id="sidebar-toggle" onclick="toggleSetting('hide_sidebar')"></div>
                                        </div>

                                <!-- Reduced Motion option removed per user request -->

                                <div class="setting-item">
                                    <div>
                                        <strong id="contrast-label">Color Contrast</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Adjust contrast level
                                        </p>
                                    </div>
                                    <select id="contrast-select" onchange="updateSetting('color_contrast', this.value)">
                                        <option value="Standard">Standard</option>
                                        <option value="High">High</option>
                                        <option value="Maximum">Maximum</option>
                                    </select>
                                </div>
                            </div>

                            <div class="settings-group" id="fb-id">
                                <h3><span class="settings-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M7 4a5 5 0 0 1 10 0v1h1a2 2 0 0 1 2 2v3a5 5 0 0 1-4 4.9V17a2 2 0 0 1-2 2v1a1 1 0 1 1-2 0v-1h-1v1a1 1 0 1 1-2 0v-1a2 2 0 0 1-2-2v-2.1A5 5 0 0 1 4 10V7a2 2 0 0 1 2-2h1V4Zm2 1h6V4a3 3 0 1 0-6 0v1Zm-3 3v2a3 3 0 1 0 6 0V8H6Zm8 0v2a3 3 0 1 0 6 0V8h-6Z"/></svg></span> Focus Companion</h3>
                                <p>Configure how your AI buddy interacts with you.</p>

                                <div class="setting-item">
                                    <div>
                                        <strong id="persona-label">Buddy Persona</strong>
                                    </div>
                                    <select id="persona-select" onchange="updateSetting('buddy_persona', this.value)">
                                        <option value="Friendly Peer">Friendly Peer (Default)</option>
                                        <option value="Gentle Mentor">Gentle Mentor</option>
                                        <option value="Motivational Coach">Motivational Coach</option>
                                    </select>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="language-label">Primary Language</strong>
                                    </div>
                                    <select id="language-select" onchange="updateSetting('language', this.value)">
                                        <option value="English">English</option>
                                        <option value="Urdu">Urdu</option>
                                        <option value="Mixed">Mixed (Code-switching)</option>
                                    </select>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="intervention-label">Proactive Interventions</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Allow Buddy to speak when you lose focus.
                                        </p>
                                    </div>
                                    <div class="toggle-switch active" id="intervention-toggle" onclick="toggleSetting('proactive_interventions')"></div>
                                </div>
                            </div>

                            <div class="settings-group" id="ph-id">
                                <h3><span class="settings-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v2h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h1V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v2h6V7a3 3 0 0 0-3-3Zm7 8H5v7h14v-7Z"/></svg></span> Privacy & Hardware</h3>
                                <p>Manage permissions and data processing.</p>

                                <div class="card privacy-card">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <span class="settings-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2a5 5 0 0 1 5 5v2h1a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h1V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v2h6V7a3 3 0 0 0-3-3Zm7 8H5v7h14v-7Z"/></svg></span>
                                        <div>
                                            <strong style="color: #5ec4a9;" id="local-processing-title">Local Edge Processing Active</strong>
                                            <p style="font-size: 12px; margin-top: 4px; color: #6e6e73;" id="local-processing-desc">
                                                Your camera feed is processed on-device and never sent to the cloud.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="camera-label">Camera Access</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Required for gaze tracking.
                                        </p>
                                    </div>
                                    <div class="toggle-switch active" id="camera-access-toggle" onclick="toggleSetting('camera_access')"></div>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong id="mic-label">Microphone Access</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Required for voice commands.
                                        </p>
                                    </div>
                                    <div>
                                        <div style="display:flex; gap:8px; align-items:center;">
                                            <div class="toggle-switch active" id="mic-access-toggle" onclick="toggleMicrophoneWithFeedback()"></div>
                                            <select id="mic-device-select" style="margin-left:8px; padding:6px; font-size:13px;"></select>
                                            <button style="margin-left:6px; padding:6px 8px;" onclick="populateMicDevices()">Refresh</button>
                                            <div id="mic-level-wrap" style="display:flex; align-items:center; gap:8px; margin-left:8px;">
                                                <div id="mic-level-meter" style="width:120px; height:10px; background:#eee; border-radius:6px; overflow:hidden;"></div>
                                                <div id="mic-level-value" style="font-size:12px; color:#6e6e73;">‚Äî</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div>
                                        <strong>Wake Word ("Hey Focus")</strong>
                                        <p style="font-size: 12px; color: #6e6e73; margin-top: 4px;">
                                            Always listen for voice commands without pressing the mic button.
                                        </p>
                                    </div>
                                    <div class="toggle-switch" id="wake-word-toggle" onclick="toggleWakeWord()"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Translation Dictionary
        const translations = {
            English: {
                greetingPrefix: "Good",
                readyText: "Ready to conquer your tasks today?",
                privacyBadge: "Privacy Mode: Local Processing Only",
                currentFocusLabel: "CURRENT FOCUS",
                webcamInactive: "Webcam inactive",
                webcamActive: "Webcam active",
                focusBuddyTitle: "Focus Buddy",
                buddyHelpText: "ALWAYS HERE TO HELP",
                currentLangBadge: "English",
                dopamineMenuTitle: "Dopamine Menu",
                tasksTitle: "Tasks",
                chunkingBadge: "Chunking Active",
                addTaskBtn: "+ Add Task",
                activityInsightsTitle: "Activity Insights",
                activityInsightsDesc: "You're making great progress! Keep the momentum going.",
                scheduleTitle: "Your Bio-Rhythm Schedule",
                scheduleDesc: "Optimized for your peak focus hours",
                timelineTitle: "Timeline",
                bioRhythmTitle: "BIO-RHYTHM INSIGHT",
                peakFocusTitle: "Peak Focus Time",
                addScheduleBtn: "+ Add Task to Schedule",
                dailyStatsTitle: "DAILY STATS",
                scheduledLabel: "Scheduled",
                breaksLabel: "Breaks",
                analyticsTitle: "Weekly Insights",
                analyticsDesc: "Understanding your focus patterns to optimize your study routine.",
                deepFocusLabel: "Deep Focus Score",
                totalFocusLabel: "Total Focus Time",
                consistencyLabel: "Consistency",
                distractionsLabel: "Distractions",
                focusRhythmTitle: "Focus Rhythm",
                focusRhythmDesc: "Your attention levels throughout the day",
                distractionTitle: "Distraction Sources",
                distractionDesc: "What broke your flow today?",
                aiInsightTitle: "AI Insight: Peak Performance",
                aiInsightDesc: "Friend, your focus consistently peaks between <strong>10:00 AM and 11:30 AM</strong>. We recommend scheduling your most challenging subjects (like Math) during this window for maximum retention.",
                settingsTitle: "Settings & Preferences",
                settingsDesc: "Customize your FocusFlow experience to match your needs.",
                dyslexiaLabel: "Dyslexia Friendly Font",
                reducedMotionLabel: "Reduced Motion",
                contrastLabel: "Color Contrast",
                personaLabel: "Buddy Persona",
                languageLabel: "Primary Language",
                interventionLabel: "Proactive Interventions",
                localProcessingTitle: "Local Edge Processing Active",
                localProcessingDesc: "Your camera feed is processed on-device and never sent to the cloud.",
                cameraLabel: "Camera Access",
                micLabel: "Microphone Access",
                navDashboard: "Dashboard",
                navSchedule: "Schedule",
                navAnalytics: "Analytics",
                navSettings: "Settings",
                accessibilitytitle: "Accessibility",
                focusbuddytitle:"Focus Buddy",
                privacytitle:"Privacy"

            },
            Urdu: {
                greetingPrefix: "ÿß⁄Ü⁄æÿß",
                readyText: "⁄©€åÿß ÿ¢Ÿæ ÿ¢ÿ¨ ÿßŸæŸÜ€í ⁄©ÿßŸÖ ŸÖ⁄©ŸÖŸÑ ⁄©ÿ±ŸÜ€í ⁄©€í ŸÑ€å€í ÿ™€åÿßÿ± €Å€å⁄∫ÿü",
                privacyBadge: "Ÿæÿ±ÿßÿ¶€åŸà€åÿ≥€å ŸÖŸà⁄à: ÿµÿ±ŸÅ ŸÑŸà⁄©ŸÑ Ÿæÿ±Ÿàÿ≥€åÿ≥ŸÜ⁄Ø",
                currentFocusLabel: "ŸÖŸàÿ¨ŸàÿØ€Å ÿ™Ÿàÿ¨€Å",
                webcamInactive: "Ÿà€åÿ® ⁄©€åŸÖ ÿ∫€åÿ± ŸÅÿπÿßŸÑ",
                webcamActive: "Ÿà€åÿ® ⁄©€åŸÖ ŸÅÿπÿßŸÑ",
                focusBuddyTitle: "ŸÅŸà⁄©ÿ≥ ÿ®⁄à€å",
                buddyHelpText: "€ÅŸÖ€åÿ¥€Å ŸÖÿØÿØ ⁄©€í ŸÑ€å€í ŸÖŸàÿ¨ŸàÿØ",
                currentLangBadge: "ÿßÿ±ÿØŸà",
                dopamineMenuTitle: "⁄àŸàŸæÿßŸÖ€åŸÜ ŸÖ€åŸÜŸà",
                tasksTitle: "⁄©ÿßŸÖ",
                chunkingBadge: "Ÿπÿßÿ≥⁄© ÿ™ŸÇÿ≥€åŸÖ ŸÅÿπÿßŸÑ",
                addTaskBtn: "+ ŸÜ€åÿß ⁄©ÿßŸÖ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫",
                activityInsightsTitle: "ÿ≥ÿ±⁄Øÿ±ŸÖ€å ⁄©€å ÿ®ÿµ€åÿ±ÿ™",
                activityInsightsDesc: "ÿ¢Ÿæ ÿ≤ÿ®ÿ±ÿØÿ≥ÿ™ ÿ™ÿ±ŸÇ€å ⁄©ÿ± ÿ±€Å€í €Å€å⁄∫! ÿ±ŸÅÿ™ÿßÿ± ÿ®ÿ±ŸÇÿ±ÿßÿ± ÿ±⁄©⁄æ€å⁄∫€î",
                scheduleTitle: "ÿ¢Ÿæ ⁄©ÿß ÿ®ÿßÿ¶€åŸà ÿ±ÿØŸÖ ÿ¥€å⁄àŸàŸÑ",
                scheduleDesc: "ÿ¢Ÿæ ⁄©€í Ÿæ€å⁄© ŸÅŸà⁄©ÿ≥ ÿßŸàŸÇÿßÿ™ ⁄©€í ŸÑ€å€í ÿ®€Åÿ™ÿ± ÿ®ŸÜÿß€åÿß ⁄Ø€åÿß",
                timelineTitle: "Ÿπÿßÿ¶ŸÖ ŸÑÿßÿ¶ŸÜ",
                bioRhythmTitle: "ÿ®ÿßÿ¶€åŸà ÿ±ÿØŸÖ ÿ®ÿµ€åÿ±ÿ™",
                peakFocusTitle: "Ÿæ€å⁄© ŸÅŸà⁄©ÿ≥ ŸàŸÇÿ™",
                addScheduleBtn: "+ ÿ¥€å⁄àŸàŸÑ ŸÖ€å⁄∫ ⁄©ÿßŸÖ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫",
                dailyStatsTitle: "ÿ±Ÿàÿ≤ÿßŸÜ€Å ⁄©€í ÿßÿπÿØÿßÿØ Ÿà ÿ¥ŸÖÿßÿ±",
                scheduledLabel: "ÿ¥€å⁄àŸàŸÑ ÿ¥ÿØ€Å",
                breaksLabel: "ŸàŸÇŸÅ€í",
                analyticsTitle: "€ÅŸÅÿ™€Å Ÿàÿßÿ± ÿ®ÿµ€åÿ±ÿ™",
                analyticsDesc: "ÿßŸæŸÜ€í ÿ™Ÿàÿ¨€Å ⁄©€í ŸÜŸÖŸàŸÜŸà⁄∫ ⁄©Ÿà ÿ≥ŸÖÿ¨⁄æ ⁄©ÿ± ŸÖÿ∑ÿßŸÑÿπ€Å ⁄©ÿß ŸÖÿπŸÖŸàŸÑ ÿ®€Åÿ™ÿ± ÿ®ŸÜÿßÿ¶€å⁄∫€î",
                deepFocusLabel: "⁄Ø€Åÿ±€å ÿ™Ÿàÿ¨€Å ⁄©ÿß ÿ≥⁄©Ÿàÿ±",
                totalFocusLabel: "⁄©ŸÑ ÿ™Ÿàÿ¨€Å ⁄©ÿß ŸàŸÇÿ™",
                consistencyLabel: "ŸÖÿ≥ÿ™ŸÇŸÑ ŸÖÿ≤ÿßÿ¨€å",
                distractionsLabel: "ÿÆŸÑŸÅÿ¥ÿßÿ±",
                focusRhythmTitle: "ÿ™Ÿàÿ¨€Å ⁄©ÿß ÿ±ÿØŸÖ",
                focusRhythmDesc: "ÿØŸÜ ÿ®⁄æÿ± ŸÖ€å⁄∫ ÿ¢Ÿæ ⁄©€å ÿ™Ÿàÿ¨€Å ⁄©€å ÿ≥ÿ∑ÿ≠",
                distractionTitle: "ÿÆŸÑŸÅÿ¥ÿßÿ± ⁄©€í ÿ∞ÿ±ÿßÿ¶ÿπ",
                distractionDesc: "ÿ¢ÿ¨ ⁄©ÿ≥ ⁄Ü€åÿ≤ ŸÜ€í ÿ¢Ÿæ ⁄©ÿß ÿ®€Åÿßÿ§ ÿ™Ÿà⁄ëÿßÿü",
                aiInsightTitle: "ÿß€í ÿ¢ÿ¶€å ÿ®ÿµ€åÿ±ÿ™: Ÿæ€å⁄© ⁄©ÿßÿ±⁄©ÿ±ÿØ⁄Ø€å",
                aiInsightDesc: "ÿØŸàÿ≥ÿ™ÿå ÿ¢Ÿæ ⁄©€å ÿ™Ÿàÿ¨€Å ŸÖÿ≥ÿ™ŸÇŸÑ ÿ∑Ÿàÿ± Ÿæÿ± <strong>ÿµÿ®ÿ≠ 10:00 ÿ≥€í 11:30</strong> ⁄©€í ÿØÿ±ŸÖ€åÿßŸÜ ÿπÿ±Ÿàÿ¨ Ÿæÿ± €ÅŸàÿ™€å €Å€í€î €ÅŸÖ ÿ™ÿ¨Ÿà€åÿ≤ ⁄©ÿ±ÿ™€í €Å€å⁄∫ ⁄©€Å ŸÖÿ¥⁄©ŸÑ ŸÖÿ∂ÿßŸÖ€åŸÜ (ÿ¨€åÿ≥€í ÿ±€åÿßÿ∂€å) ÿßÿ≥ ŸàŸÇÿ™ ÿ¥€å⁄àŸàŸÑ ⁄©ÿ±€å⁄∫€î",
                settingsTitle: "ÿ™ÿ±ÿ™€åÿ®ÿßÿ™ ÿßŸàÿ± ÿ™ÿ±ÿ¨€åÿ≠ÿßÿ™",
                settingsDesc: "ÿßŸæŸÜ€í FocusFlow ÿ™ÿ¨ÿ±ÿ®€í ⁄©Ÿà ÿßŸæŸÜ€å ÿ∂ÿ±Ÿàÿ±€åÿßÿ™ ⁄©€í ŸÖÿ∑ÿßÿ®ŸÇ ÿ®ŸÜÿßÿ¶€å⁄∫€î",
                dyslexiaLabel: "⁄àÿ≥ŸÑ€å⁄©ÿ≥⁄© ⁄©€í ŸÑ€å€í ŸÖŸàÿ≤Ÿà⁄∫ ŸÅŸàŸÜŸπ",
                reducedMotionLabel: "ÿ≠ÿ±⁄©ÿßÿ™ ⁄©ŸÖ ⁄©ÿ±€å⁄∫",
                contrastLabel: "ÿ±ŸÜ⁄Ø ⁄©ÿß ÿ™ÿ∂ÿßÿØ",
                personaLabel: "ÿ®⁄à€å ÿ¥ÿÆÿµ€åÿ™",
                languageLabel: "ÿ®ŸÜ€åÿßÿØ€å ÿ≤ÿ®ÿßŸÜ",
                interventionLabel: "ŸÅÿπÿßŸÑ ŸÖÿØÿßÿÆŸÑÿ™",
                localProcessingTitle: "ŸÑŸà⁄©ŸÑ ÿß€åÿ¨ Ÿæÿ±Ÿàÿ≥€åÿ≥ŸÜ⁄Ø ŸÅÿπÿßŸÑ",
                localProcessingDesc: "ÿ¢Ÿæ ⁄©ÿß ⁄©€åŸÖÿ±€Å ŸÅ€å⁄à ⁄à€åŸàÿßÿ¶ÿ≥ Ÿæÿ± Ÿæÿ±Ÿàÿ≥€åÿ≥ €ÅŸàÿ™ÿß €Å€í ÿßŸàÿ± ⁄©ŸÑÿßÿ§⁄à Ÿæÿ± ŸÜ€Å€å⁄∫ ÿ®⁄æ€åÿ¨ÿß ÿ¨ÿßÿ™ÿß€î",
                cameraLabel: "⁄©€åŸÖÿ±€Å ÿ±ÿ≥ÿßÿ¶€å",
                micLabel: "ŸÖÿßÿ¶€å⁄©ÿ±ŸàŸÅŸàŸÜ ÿ±ÿ≥ÿßÿ¶€å",
                navDashboard: "⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à",
                navSchedule: "ÿ¥€å⁄àŸàŸÑ",
                navAnalytics: "ÿ™ÿ¨ÿ≤€åÿßÿ™",
                navSettings: "ÿ™ÿ±ÿ™€åÿ®ÿßÿ™",
                accessibilitytitle: "ÿ±ÿ≥ÿßÿ¶€å",
                focusbuddytitle:"ÿ™Ÿàÿ¨€Å ⁄©ÿß ÿ≥ÿßÿ™⁄æ€å",
                privacytitle:"ÿ±ÿßÿ≤ÿØÿßÿ±€å"
            }
        };

        // State management
        let appState = {
            currentView: 'dashboard',
            cameraActive: false,
            microphoneActive: false,
            wakeWordActive: false,
            focusScore: 0,
            tasks: [],
            schedule: [],
            analytics: {},
            focusHistory: [],
            settings: {
                language: 'English',
                proactive_interventions: true,
                dyslexia_font: false,
                dark_mode: false,
                color_blind_mode: false,
                hide_sidebar: false,
                color_contrast: 'Standard',
                buddy_persona: 'Friendly Peer',
                camera_access: true
            },
            audioInitialized: false
        };

        let currentScheduleDate = new Date();

        // Apply Language
        function applyLanguage() {
            const lang = appState.settings.language;
            const t = translations[lang];

            document.body.dir = lang === 'Urdu' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang === 'Urdu' ? 'ur' : 'en';

            // Greeting
            const hour = new Date().getHours();
            let timeOfDay = 'Morning';
            if (hour >= 12 && hour < 17) timeOfDay = 'Afternoon';
            if (hour >= 17) timeOfDay = 'Evening';
            document.getElementById('greeting').textContent = timeOfDay;
            document.getElementById('greeting-prefix').innerHTML = `${t.greetingPrefix} <span id="greeting">${timeOfDay}</span>, Friend`;

            // Safe text update function
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };
            const setHTML = (id, html) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            };

            setText('ready-text', t.readyText);
            setText('privacy-badge', `<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="display: inline-block; margin-right: 6px;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>${t.privacyBadge}`);
            setText('current-focus-label', t.currentFocusLabel);
            setText('webcam-status', appState.cameraActive ? t.webcamActive : t.webcamInactive);
            setText('focus-buddy-title', t.focusBuddyTitle);
            setText('buddy-help-text', t.buddyHelpText);
            setText('current-lang-badge', t.currentLangBadge);
            setText('dopamine-menu-title', t.dopamineMenuTitle);
            setText('tasks-title', t.tasksTitle);
            setText('chunking-badge', t.chunkingBadge);
            setText('add-task-btn', t.addTaskBtn);
            setText('activity-insights-title', t.activityInsightsTitle);
            setText('activity-insights-desc', t.activityInsightsDesc);
            setText('schedule-title', t.scheduleTitle);
            setHTML('schedule-desc', `${t.scheduleDesc} (<span id="peak-hours"></span>)`);
            setText('timeline-title', t.timelineTitle);
            setText('bio-rhythm-title', t.bioRhythmTitle);
            setText('peak-focus-title', t.peakFocusTitle);
            setText('add-schedule-btn', t.addScheduleBtn);
            setText('daily-stats-title', t.dailyStatsTitle);
            setText('scheduled-label', t.scheduledLabel);
            setText('breaks-label', t.breaksLabel);
            setText('analytics-title', t.analyticsTitle);
            setText('analytics-desc', t.analyticsDesc);
            setText('deep-focus-label', t.deepFocusLabel);
            setText('total-focus-label', t.totalFocusLabel);
            setText('consistency-label', t.consistencyLabel);
            setText('distractions-label', t.distractionsLabel);
            setText('focus-rhythm-title', t.focusRhythmTitle);
            setText('focus-rhythm-desc', t.focusRhythmDesc);
            setText('distraction-title', t.distractionTitle);
            setText('distraction-desc', t.distractionDesc);
            setText('ai-insight-title', t.aiInsightTitle);
            // Only set the static AI insight description if it hasn't been replaced by dynamic content
            const aiDescEl = document.getElementById('ai-insight-desc');
            if (aiDescEl && aiDescEl.dataset.dynamic !== 'true') aiDescEl.innerHTML = t.aiInsightDesc;
            setText('settings-title', t.settingsTitle);
            setText('settings-desc', t.settingsDesc);
            setText('dyslexia-label', t.dyslexiaLabel);
            setText('reduced-motion-label', t.reducedMotionLabel);
            setText('contrast-label', t.contrastLabel);
            setText('persona-label', t.personaLabel);
            setText('language-label', t.languageLabel);
            setText('intervention-label', t.interventionLabel);
            setText('local-processing-title', t.localProcessingTitle);
            setText('local-processing-desc', t.localProcessingDesc);
            setText('camera-label', t.cameraLabel);
            setText('mic-label', t.micLabel);
            setText('accessibility-label', t.accessibilitytitle);
            setText('focusbuddy-label', t.focusbuddytitle);
            setText('privacy-label', t.privacytitle);

            // Sidebar
            setText('nav-dashboard-label', t.navDashboard);
            setText('nav-schedule-label', t.navSchedule);
            setText('nav-analytics-label', t.navAnalytics);
            setText('nav-settings-label', t.navSettings);
        }

        // Initialize app
        async function init() {
            updateGreeting();
            await loadState();
            renderTasks();
            applyLanguage(); // Initial apply

            // Populate microphone devices in settings
            try { populateMicDevices(); } catch (e) { console.warn('populateMicDevices failed', e); }

            document.body.addEventListener('click', () => {
                if (!appState.audioInitialized) {
                    const prime = new SpeechSynthesisUtterance("");
                    window.speechSynthesis.speak(prime);
                    appState.audioInitialized = true;
                    console.log("Audio Engine Unlocked");
                }

                // Also attempt to create/resume the notification audio context on first user gesture
                try {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (AudioCtx && !notificationAudioCtx) {
                        notificationAudioCtx = new AudioCtx();
                        if (notificationAudioCtx.state === 'suspended') notificationAudioCtx.resume().catch(() => {});
                    } else if (notificationAudioCtx && notificationAudioCtx.state === 'suspended') {
                        notificationAudioCtx.resume().catch(() => {});
                    }
                } catch (e) { /* ignore */ }
            }, { once: true });

            setInterval(updateState, 300);
            setInterval(checkBuddyMessages, 3000);
        }

        function updateGreeting() {
            // Called inside applyLanguage now
        }

        async function loadState() {
            try {
                const response = await fetch('/api/state');
                const data = await response.json();

                appState = {
                    ...appState,
                    focusScore: data.focus_score || 0,
                    cameraActive: data.camera_active || false,
                    microphoneActive: data.microphone_active || false,
                    wakeWordActive: data.wake_word_active || false,
                    tasks: data.tasks || [],
                    analytics: data.analytics || {},
                    settings: { ...appState.settings, ...data.settings }
                };

                updateUI();
                updateFocusDisplay();
                applySettings();
                applyLanguage();
            } catch (error) {
                console.error('Error loading state:', error);
                applyLanguage(); // Still apply default
            }
        }

        async function updateState() {
            await loadState();
            updateFocusDisplay();
            updateUI();
        }

        function updateFocusDisplay() {
            const focusPercentage = document.getElementById('focus-percentage');
            const focusBar = document.getElementById('focus-bar');
            if (focusPercentage && focusBar) {
                focusPercentage.textContent = appState.focusScore + '%';
                focusBar.style.width = appState.focusScore + '%';

                // Update fill color based on focus score
                const fillEl = (focusBar.classList && focusBar.classList.contains('progress-fill')) ? focusBar : focusBar.querySelector('.progress-fill');
                if (fillEl) {
                    const score = Number(appState.focusScore) || 0;
                    if (score >= 75) {
                        fillEl.style.background = 'linear-gradient(90deg, #5ec4a9, #98d8c8)';
                    } else if (score >= 50) {
                        fillEl.style.background = 'linear-gradient(90deg, #fbbf24, #f97316)';
                    } else {
                        fillEl.style.background = 'linear-gradient(90deg, #ef4444, #f43f5e)';
                    }
                }

                appState.focusHistory.push(appState.focusScore);
                if (appState.focusHistory.length > 20) appState.focusHistory.shift();
            }
        }

        function updateUI() {
            if (appState.cameraActive) {
                document.getElementById('webcam-status').textContent = translations[appState.settings.language].webcamActive;
                document.getElementById('video-container').classList.remove('hidden');
            } else {
                document.getElementById('webcam-status').textContent = translations[appState.settings.language].webcamInactive;
                document.getElementById('video-container').classList.add('hidden');
            }

            // Sync camera UI toggles (settings permission + main camera button)
            const cameraSettingsToggle = document.getElementById('camera-access-toggle');
            const cameraMainButton = document.getElementById('camera-toggle');
            if (cameraSettingsToggle) cameraSettingsToggle.classList.toggle('active', !!appState.settings.camera_access);
            if (cameraMainButton) {
                cameraMainButton.classList.toggle('active', !!appState.cameraActive);
                cameraMainButton.disabled = !appState.settings.camera_access;
            }

            // Sync microphone UI toggles (chat mic button + settings toggle)
            const micButton = document.getElementById('mic-toggle');
            const micSettingsToggle = document.getElementById('mic-access-toggle');
            if (micButton) micButton.classList.toggle('active', !!appState.microphoneActive);
            if (micSettingsToggle) micSettingsToggle.classList.toggle('active', !!appState.microphoneActive);

            // Sync wake word toggle
            const wakeWordToggle = document.getElementById('wake-word-toggle');
            if (wakeWordToggle) wakeWordToggle.classList.toggle('active', !!appState.wakeWordActive);

            if (appState.analytics) {
                const deepFocusEl = document.getElementById('deep-focus-score');
                const totalTimeEl = document.getElementById('total-focus-time');
                const consistencyEl = document.getElementById('consistency');
                const distractionsEl = document.getElementById('distractions');

                if (deepFocusEl) deepFocusEl.textContent = (appState.analytics.deep_focus_score || 78) + '%';
                if (totalTimeEl) totalTimeEl.textContent = appState.analytics.total_focus_time || "4h 12m";
                if (consistencyEl) consistencyEl.textContent = (appState.analytics.consistency || 85) + '%';
                if (distractionsEl) distractionsEl.textContent = appState.analytics.distractions || 12;

                if (appState.currentView === 'analytics') {
                    renderDistractionChart();
                    renderFocusChart();
                }

                // Update Activity Insights on Dashboard
                if (appState.currentView === 'dashboard') {
                    updateActivityInsights();
                }
            }
        }

        function updateActivityInsights() {
            try {
                const contentEl = document.getElementById('activity-insights-content');
                const tipEl = document.getElementById('activity-insights-tip');
                if (!contentEl || !tipEl || !appState.analytics) return;

                const a = appState.analytics;
                const deep = Number(a.deep_focus_score || 0);
                const time = a.total_focus_time || '0h 0m';
                const cons = Number(a.consistency || 0);
                const dist = Number(a.distractions || 0);
                const sources = a.distraction_sources || {};
                const topSource = Object.keys(sources).sort((x,y) => (sources[y]||0) - (sources[x]||0))[0] || 'N/A';
                const peak = a.peak_insight_time || '‚Äî';

                let tip = '';
                if (cons < 70 || dist >= 5) {
                    tip = 'üí™ Take a 2‚Äëmin stretch break and refocus on one subtask.';
                } else if (deep >= 80) {
                    tip = '‚ö° Great flow! Queue a challenging subtask while focus is high.';
                } else {
                    tip = 'üìà Keep a steady pace. Small wins add up.';
                }

                contentEl.innerHTML = `
                    <div class="metric-card">
                        <span class="metric-value">${deep}%</span>
                        <span class="metric-label">Deep Focus</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" style="font-size: 16px;">${time}</span>
                        <span class="metric-label">Total Time</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${cons}%</span>
                        <span class="metric-label">Consistency</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${dist}</span>
                        <span class="metric-label">Distractions</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" style="font-size: 14px;">${topSource}</span>
                        <span class="metric-label">Top Source</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" style="font-size: 12px;">${peak}</span>
                        <span class="metric-label">Peak Window</span>
                    </div>
                `;
                tipEl.textContent = tip;
            } catch (e) { console.warn('updateActivityInsights failed', e); }
        }

        function speakMessage(text) {
            if (!appState.settings.proactive_interventions || !appState.audioInitialized) return;
            window.speechSynthesis.cancel();
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                const langMap = { 'English': 'en-US', 'Urdu': 'ur-PK', 'Mixed': 'en-US' };
                utterance.lang = langMap[appState.settings.language] || 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Show a temporary notice when camera access is disabled
        function showCameraAccessNotice() {
            showFeedback('Camera access is disabled in Settings. Enable it there to use the camera.', 'warning');
        }

        // Lightweight, ear-friendly notification sound using WebAudio
        // Gentle sine chime with soft attack and decay
        let notificationAudioCtx = null;
        function playNotificationSound() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                if (!notificationAudioCtx) notificationAudioCtx = new AudioCtx();

                // Resume if suspended due to autoplay policies
                if (notificationAudioCtx.state === 'suspended') {
                    notificationAudioCtx.resume().catch(() => {});
                }

                const now = notificationAudioCtx.currentTime;

                // Master gain (low volume for comfort)
                const masterGain = notificationAudioCtx.createGain();
                masterGain.gain.value = 0.0;
                masterGain.connect(notificationAudioCtx.destination);

                // Main gentle sine tone (pleasant frequency)
                const tone = notificationAudioCtx.createOscillator();
                tone.type = 'sine';
                tone.frequency.value = 880; // A5, but we'll keep it soft
                tone.connect(masterGain);

                // Subtle harmonic for warmth
                const harmonic = notificationAudioCtx.createOscillator();
                harmonic.type = 'sine';
                harmonic.frequency.value = 1320; // 1.5x harmonic
                const harmGain = notificationAudioCtx.createGain();
                harmGain.gain.value = 0.12; // much quieter harmonic
                harmonic.connect(harmGain);
                harmGain.connect(masterGain);

                // Envelope: soft attack and slow decay
                const attack = 0.02;
                const sustain = 0.18;
                const decay = 0.36;

                masterGain.gain.setValueAtTime(0.0, now);
                masterGain.gain.linearRampToValueAtTime(0.06, now + attack); // soft peak
                masterGain.gain.exponentialRampToValueAtTime(0.0001, now + attack + sustain + decay);

                tone.start(now);
                harmonic.start(now + 0.01);

                tone.stop(now + attack + sustain + decay + 0.02);
                harmonic.stop(now + attack + sustain + decay + 0.02);
            } catch (e) {
                // ignore audio errors
            }
        }

        // General feedback helper
        function showFeedback(message, type = 'success', ms = 3000) {
            const el = document.getElementById('settings-feedback');
            if (!el) return;
            el.textContent = message;
            el.className = ''; // reset
            el.classList.add(type === 'warning' ? 'warning' : 'success');
            // animate visible
            el.classList.add('visible');
            // play sound for the notification
            playNotificationSound();
            // hide after timeout
            setTimeout(() => {
                el.classList.remove('visible');
            }, ms);
        }

        function showView(viewName) {
            const views = ['dashboard', 'schedule', 'analytics', 'settings'];
            views.forEach(view => {
                const element = document.getElementById(view + '-view');
                if (element) {
                    element.classList.toggle('hidden', view !== viewName);
                }
            });

            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.toggle('active', views[index] === viewName);
            });

            appState.currentView = viewName;

            // Toggle Focus Buddy visibility based on active view
            const dashboardBuddy = document.getElementById('dashboard-focus-buddy');
            const sidebarBuddy = document.getElementById('sidebar-focus-buddy');
            if (dashboardBuddy && sidebarBuddy) {
                dashboardBuddy.style.display = viewName === 'dashboard' ? 'block' : 'none';
                sidebarBuddy.style.display = viewName !== 'dashboard' ? 'block' : 'none';
            }

            if (viewName === 'schedule') loadSchedule();
            if (viewName === 'analytics') loadAnalytics();
        }

        async function toggleCamera() {
            // Respect the camera access setting
            if (!appState.settings.camera_access) {
                showCameraAccessNotice();
                return;
            }

            try {
                const response = await fetch('/api/toggle_camera', { method: 'POST' });
                const data = await response.json();
                appState.cameraActive = data.camera_active;
                updateUI();
            } catch (error) {
                console.error('Error toggling camera:', error);
            }
        }

        async function toggleMicrophone() {
            try {
                const response = await fetch('/api/toggle_microphone', { method: 'POST' });
                const data = await response.json();
                appState.microphoneActive = data.microphone_active;
                updateUI();
            } catch (error) {
                console.error('Error toggling microphone:', error);
            }
        }

        // Provide feedback when microphone is toggled
        async function toggleMicrophoneWithFeedback() {
            try {
                const response = await fetch('/api/toggle_microphone', { method: 'POST' });
                const data = await response.json();
                appState.microphoneActive = data.microphone_active;
                updateUI();
                showFeedback(appState.microphoneActive ? 'Microphone turned on' : 'Microphone turned off');
            } catch (error) {
                console.error('Error toggling microphone:', error);
            }
        }

        // Start speech recognition and send transcript to server for processing
        async function populateMicDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const list = devices.filter(d => d.kind === 'audioinput');
                const sel = document.getElementById('mic-device-select');
                if (!sel) return;
                sel.innerHTML = '';
                list.forEach((d, i) => {
                    const opt = document.createElement('option');
                    opt.value = d.deviceId;
                    opt.text = d.label || `Microphone ${i+1}`;
                    sel.appendChild(opt);
                });
                const saved = (appState.settings && appState.settings.mic_device_id) ? appState.settings.mic_device_id : localStorage.getItem('mic_device_id');
                if (saved) sel.value = saved;
                sel.onchange = () => {
                    const id = sel.value;
                    appState.settings.mic_device_id = id;
                    localStorage.setItem('mic_device_id', id);
                    try { updateSetting('mic_device_id', id); } catch (e) { console.warn('save mic id failed', e); }
                };
            } catch (e) { console.warn('populateMicDevices error', e); }
        }

        function updateMicMeter(rms) {
            try {
                const meter = document.getElementById('mic-level-meter');
                const valEl = document.getElementById('mic-level-value');
                if (!meter) return;
                const normalized = Math.min(1, rms * 200); // scale small RMS to 0..1
                meter.innerHTML = `<div style="height:100%; width:${Math.round(normalized*100)}%; background:#5ec4a9;"></div>`;
                if (valEl) valEl.textContent = normalized > 0 ? (Math.round(normalized*100) + '%') : '‚Äî';
            } catch (e) { console.warn('updateMicMeter error', e); }
        }

        async function startVoiceCapture() {
    // Ensure browser supports Web Speech API
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showFeedback('Speech recognition not supported in this browser.', 'warning');
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = appState.settings.language === 'Urdu' ? 'ur-PK' : 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    let heardSomething = false;

    recognition.onstart = () => {
        console.log('Recognition started');
        showFeedback('Listening...', 'success', 2000);
        appState.microphoneActive = true;
        updateUI();
    };

    recognition.onresult = async (event) => {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        transcript = transcript.trim();
        console.log('Transcript:', transcript);
        heardSomething = true;

        if (!transcript) return;

        const buddyEl = document.getElementById('buddy-message');
        if (buddyEl) buddyEl.textContent = 'You: ' + transcript;

        // Send to server
        try {
            const resp = await fetch('/api/voice_command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transcript: transcript })
            });
            const data = await resp.json();
            const serverReply = data.reply || "I couldn't process that.";
            
            if (buddyEl) buddyEl.textContent = serverReply;
            speakMessage(serverReply);

            if (data.action) {
                handleServerAction(data.action);
            }
        } catch (err) {
            console.error('Voice command error', err);
            showFeedback('Failed to send voice command', 'warning');
        }
    };

    recognition.onerror = (e) => {
        console.error('Recognition error', e);
        showFeedback('Speech recognition error: ' + (e.error || 'unknown'), 'warning', 3000);
        appState.microphoneActive = false;
        updateUI();
    };

    recognition.onend = () => {
        console.log('Recognition ended');
        appState.microphoneActive = false;
        updateUI();
        
        if (!heardSomething) {
            showFeedback('No speech detected. Please try again.', 'warning', 2000);
        }
    };

    try {
        recognition.start();
    } catch (e) {
        console.error('Failed to start recognition', e);
        showFeedback('Could not start speech recognition.', 'warning');
    }
}
        // Wake word continuous listening
        let wakeWordRecognition = null;
        let commandRecognition = null;
        const WAKE_WORDS = ['hey focus', 'focus flow', 'hey focusflow'];

        function startWakeWordListening() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showFeedback('Speech recognition not supported', 'warning');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            wakeWordRecognition = new SpeechRecognition();
            wakeWordRecognition.lang = 'en-US';
            wakeWordRecognition.continuous = true;
            wakeWordRecognition.interimResults = true;

            wakeWordRecognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript.toLowerCase().trim();
                    console.log('Wake word listening:', transcript);
                    
                    // Check if any wake word is detected
                    const wakeWordDetected = WAKE_WORDS.some(word => transcript.includes(word));
                    
                    if (wakeWordDetected && event.results[i].isFinal) {
                        console.log('Wake word detected!');
                        showFeedback('Listening for command...', 'success', 1500);
                        
                        // Give audio feedback
                        const responses = [
                            'I am listening',
                            'Yes, I am here',
                            'What do you want me to do',
                            'How can I help',
                            'Ready'
                        ];
                        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                        speakMessage(randomResponse);
                        
                        // Stop wake word recognition temporarily
                        wakeWordRecognition.stop();
                        // Start command recognition
                        startCommandListening();
                    }
                }
            };

            wakeWordRecognition.onerror = (e) => {
                if (e.error !== 'no-speech') {
                    console.error('Wake word recognition error:', e.error);
                }
                // Auto-restart on error (unless manually stopped)
                if (appState.wakeWordActive && e.error !== 'aborted') {
                    setTimeout(() => {
                        if (appState.wakeWordActive) {
                            try { wakeWordRecognition.start(); } catch (err) {}
                        }
                    }, 1000);
                }
            };

            wakeWordRecognition.onend = () => {
                // Auto-restart if still active
                if (appState.wakeWordActive) {
                    setTimeout(() => {
                        if (appState.wakeWordActive && !commandRecognition) {
                            try { wakeWordRecognition.start(); } catch (err) {}
                        }
                    }, 100);
                }
            };

            try {
                wakeWordRecognition.start();
                console.log('Wake word listening started');
            } catch (e) {
                console.error('Failed to start wake word listening:', e);
            }
        }

        function stopWakeWordListening() {
            if (wakeWordRecognition) {
                try {
                    wakeWordRecognition.stop();
                    wakeWordRecognition = null;
                } catch (e) {
                    console.error('Error stopping wake word:', e);
                }
            }
        }

        function startCommandListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            commandRecognition = new SpeechRecognition();
            commandRecognition.lang = appState.settings.language === 'Urdu' ? 'ur-PK' : 'en-US';
            commandRecognition.interimResults = false;
            commandRecognition.maxAlternatives = 1;

            let heardCommand = false;

            commandRecognition.onresult = async (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                transcript = transcript.trim();
                console.log('Command:', transcript);
                heardCommand = true;

                if (!transcript) return;

                const buddyEl = document.getElementById('buddy-message');
                if (buddyEl) buddyEl.textContent = 'You: ' + transcript;

                // Send to server
                try {
                    const resp = await fetch('/api/voice_command', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transcript: transcript })
                    });
                    const data = await resp.json();
                    const serverReply = data.reply || "I couldn't process that.";
                    
                    if (buddyEl) buddyEl.textContent = serverReply;
                    speakMessage(serverReply);

                    if (data.action) {
                        handleServerAction(data.action);
                    }
                } catch (err) {
                    console.error('Voice command error', err);
                    showFeedback('Failed to send voice command', 'warning');
                }
            };

            commandRecognition.onerror = (e) => {
                console.error('Command recognition error:', e.error);
            };

            commandRecognition.onend = () => {
                commandRecognition = null;
                if (!heardCommand) {
                    showFeedback('No command heard', 'warning', 1500);
                }
                // Restart wake word listening
                if (appState.wakeWordActive) {
                    setTimeout(() => {
                        if (appState.wakeWordActive) {
                            startWakeWordListening();
                        }
                    }, 500);
                }
            };

            try {
                commandRecognition.start();
            } catch (e) {
                console.error('Failed to start command recognition:', e);
                // Restart wake word listening on failure
                if (appState.wakeWordActive) {
                    setTimeout(() => startWakeWordListening(), 500);
                }
            }
        }

        async function toggleWakeWord() {
            try {
                const response = await fetch('/api/toggle_wake_word', { method: 'POST' });
                const data = await response.json();
                appState.wakeWordActive = data.wake_word_active;
                
                const toggle = document.getElementById('wake-word-toggle');
                if (toggle) {
                    toggle.classList.toggle('active', appState.wakeWordActive);
                }
                
                if (appState.wakeWordActive) {
                    showFeedback('Wake word activated. Say "Hey Focus" to give commands.', 'success', 3000);
                    startWakeWordListening();
                } else {
                    showFeedback('Wake word deactivated', 'success', 2000);
                    stopWakeWordListening();
                }
            } catch (error) {
                console.error('Error toggling wake word:', error);
                showFeedback('Failed to toggle wake word', 'warning');
            }
        }

        async function checkBuddyMessages() {
            try {
                const response = await fetch('/api/buddy_messages');
                const messages = await response.json();
                if (messages.length > 0) {
                    const latestMsg = messages[messages.length - 1];
                    document.getElementById('buddy-message').textContent = latestMsg;
                    speakMessage(latestMsg);
                }
            } catch (error) {
                console.error('Error checking buddy messages:', error);
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                document.getElementById('buddy-message').textContent = 'You: ' + message;
                input.value = '';
                // send to server for unified handling (same as voice)
                fetch('/api/voice_command', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ transcript: message }) })
                    .then(r => r.json())
                    .then(data => {
                        const serverReply = data.reply || "I couldn't process that.";
                        document.getElementById('buddy-message').textContent = serverReply;
                        speakMessage(serverReply);
                        if (data.action) handleServerAction(data.action);
                    }).catch(err => {
                        console.error('sendMessage error', err);
                        document.getElementById('buddy-message').textContent = "Sorry, I couldn't reach the assistant.";
                    });
            }
        }

        function handleServerAction(action) {
    if (!action || !action.type) return;
    
    console.log('Handling action:', action);
    
    // Handle different action types
    if (action.type === 'add_task' && action.task) {
        appState.tasks.push(action.task);
        renderTasks();
        showFeedback('Task added by Buddy.', 'success', 2500);
    } else if (action.type === 'add_schedule' && action.entry) {
        showFeedback('Schedule created by Buddy.', 'success', 2500);
        loadState();
    } else if (action.type === 'suggest_dopamine' && action.suggestion) {
        document.getElementById('buddy-message').textContent = action.suggestion;
        speakMessage(action.suggestion);
    } else if (action.type === 'report_focus') {
        showFeedback(`Focus: ${action.value}%`, 'success', 2500);
    } else if (action.type === 'camera') {
        appState.cameraActive = !!action.value; 
        updateUI();
    } else if (action.type === 'setting' && action.name) {
        appState.settings[action.name] = action.value; 
        applySettings();
        showFeedback(`Setting updated: ${action.name}`, 'success', 2000);
    } else if (action.type === 'navigate' && action.view) {
        showView(action.view);
        showFeedback(`Navigated to ${action.view}`, 'success', 1500);
    } else if (action.type === 'removed_task' && action.task) {
        appState.tasks = appState.tasks.filter(t => t.id !== action.task.id);
        renderTasks();
        showFeedback(`Task "${action.task.title}" removed`, 'success', 2500);
    } else if (action.type === 'wake_word') {
        appState.wakeWordActive = action.value;
        const wakeWordToggle = document.getElementById('wake-word-toggle');
        if (wakeWordToggle) {
            wakeWordToggle.classList.toggle('active', appState.wakeWordActive);
        }
        if (appState.wakeWordActive) {
            startWakeWordListening();
        } else {
            stopWakeWordListening();
        }
    }
}
        function renderTasks() {
            const container = document.getElementById('tasks-container');
            if (!container) return;
            container.innerHTML = '';
            appState.tasks.forEach(task => {
                const taskHTML = `
                    <div class="task-group">
                        <h3>
                            ${task.title}
                            <span class="task-progress">${task.completed}/${task.total}</span>
                        </h3>
                        ${task.subtasks.map(subtask => `
                            <div class="subtask">
                                <div class="checkbox ${subtask.completed ? 'checked' : ''}" 
                                     onclick="toggleSubtask(${task.id}, ${subtask.id})">
                                    ${subtask.completed ? '‚úì' : ''}
                                </div>
                                <div class="subtask-text ${subtask.completed ? 'completed' : ''}">
                                    ${subtask.text}
                                </div>
                                <div class="subtask-duration">${subtask.duration}m</div>
                                <div class="progress-mini">
                                    <div class="progress-mini-fill" style="width: ${subtask.completed ? '100' : '0'}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.innerHTML += taskHTML;
            });
        }

        async function toggleSubtask(taskId, subtaskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            const subtask = task.subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;
            subtask.completed = !subtask.completed;
            task.completed = task.subtasks.filter(st => st.completed).length;
            renderTasks();
            if (subtask.completed) {
                const buddyMessage = document.getElementById('buddy-message');
                buddyMessage.textContent = "Congratulations! Great job completing that subtask! üéâ";
                if (task.completed === task.total) {
                    buddyMessage.textContent += " You've completed the entire task!";
                }
            }
            await fetch('/api/toggle_subtask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, subtask_id: subtaskId })
            });
        }

        async function addTask() {
            openAddTaskModal();
        }

        function openAddTaskModal() {
            const backdrop = document.getElementById('task-modal-backdrop') || createTaskModal();
            backdrop.classList.add('active');
            setTimeout(() => document.getElementById('task-title-input').focus(), 100);
        }

        function closeAddTaskModal() {
            const backdrop = document.getElementById('task-modal-backdrop');
            if (backdrop) backdrop.classList.remove('active');
        }

        function createTaskModal() {
            const backdrop = document.createElement('div');
            backdrop.id = 'task-modal-backdrop';
            backdrop.className = 'modal-backdrop';
            backdrop.innerHTML = `
                <div id="task-modal">
                    <h2>‚ú® Create New Task</h2>
                    <p class="modal-subtitle">Break it down into focused chunks</p>
                    <div class="modal-form-group">
                        <label for="task-title-input">Task Title</label>
                        <input type="text" id="task-title-input" placeholder="e.g., Write Essay, Study Math..." />
                    </div>
                    <div class="modal-form-group">
                        <label>Difficulty</label>
                        <div class="modal-difficulty">
                            <div class="difficulty-option" onclick="setDifficulty(this, 'easy')">üìö Easy</div>
                            <div class="difficulty-option" onclick="setDifficulty(this, 'medium')">‚öôÔ∏è Medium</div>
                            <div class="difficulty-option" onclick="setDifficulty(this, 'hard')">üî• Hard</div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="submitAddTask()">Create Task</button>
                    </div>
                </div>
            `;
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) closeAddTaskModal();
            });
            document.body.appendChild(backdrop);
            return backdrop;
        }

        let selectedDifficulty = 'medium';
        function setDifficulty(el, level) {
            document.querySelectorAll('.difficulty-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedDifficulty = level;
        }

        async function submitAddTask() {
            const title = document.getElementById('task-title-input').value.trim();
            if (!title) {
                showFeedback('Please enter a task title', 'warning');
                return;
            }
            closeAddTaskModal();
            try {
                const response = await fetch('/api/add_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, difficulty: selectedDifficulty })
                });
                const newTask = await response.json();
                appState.tasks.push(newTask);
                renderTasks();
                showFeedback(`Task "${title}" created! üèÉ`);
            } catch (error) {
                console.error('Error adding task:', error);
                showFeedback('Failed to create task', 'warning');
            }
        }

        async function loadSchedule() {
            try {
                const dateStr = currentScheduleDate.toISOString().split('T')[0];
                const response = await fetch(`/api/schedule?date=${dateStr}`);
                const data = await response.json();
                appState.schedule = data.schedule;
                appState.bio_rhythm = data.bio_rhythm;
                renderSchedule();

                const today = new Date();
                const isToday = currentScheduleDate.toDateString() === today.toDateString();
                const formatted = currentScheduleDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                document.getElementById('current-date').textContent = isToday ? `Today, ${formatted}` : formatted;

                const peakStr = `${data.bio_rhythm.peak_start} - ${data.bio_rhythm.peak_end}`;
                document.getElementById('peak-hours').textContent = peakStr;
                document.getElementById('peak-time-display').textContent = peakStr;

                const hour = parseInt(data.bio_rhythm.peak_start.split(':')[0]);
                const period = hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening';
                document.getElementById('bio-insight').textContent = 
                    `Based on your recent activity, you seem most alert in the ${period}. We've scheduled your hardest tasks during this window for optimal performance.`;

                if (data.daily_stats) {
                    document.getElementById('scheduled-time').textContent = data.daily_stats.scheduled;
                    document.getElementById('breaks-time').textContent = data.daily_stats.breaks;
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function prevDay() {
            currentScheduleDate.setDate(currentScheduleDate.getDate() - 1);
            loadSchedule();
        }

        function nextDay() {
            currentScheduleDate.setDate(currentScheduleDate.getDate() + 1);
            loadSchedule();
        }

        function renderSchedule() {
            const timeline = document.getElementById('schedule-timeline');
            if (!timeline) return;
            timeline.innerHTML = '';
            appState.schedule.forEach(item => {
                const energyClass = `energy-${item.energy.toLowerCase()}`;
                const itemHTML = `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-time">
                                ${item.time} (${item.duration}m)
                                <span class="energy-badge ${energyClass}">
                                    Energy: ${item.energy}
                                </span>
                            </div>
                            <strong>${item.title}</strong>
                            ${item.type === 'Deep Focus' ? '<div style="margin-top: 4px; font-size: 12px; color: #6e6e73;"><svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor" style="display: inline-block; margin-right: 4px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' + item.type + '</div>' : ''}
                        </div>
                    </div>
                `;
                timeline.innerHTML += itemHTML;
            });
        }

        function addScheduleTask() {
            openScheduleModal();
        }

        function openScheduleModal() {
            const backdrop = document.getElementById('schedule-modal-backdrop') || createScheduleModal();
            backdrop.classList.add('active');
            setTimeout(() => document.getElementById('schedule-task-input').focus(), 100);
        }

        function closeScheduleModal() {
            const backdrop = document.getElementById('schedule-modal-backdrop');
            if (backdrop) backdrop.classList.remove('active');
        }

        function createScheduleModal() {
            const backdrop = document.createElement('div');
            backdrop.id = 'schedule-modal-backdrop';
            backdrop.className = 'modal-backdrop';
            backdrop.innerHTML = `
                <div id="task-modal">
                    <h2>üìÖ Add to Schedule</h2>
                    <p class="modal-subtitle">We'll slot it during your peak focus hours</p>
                    <div class="modal-form-group">
                        <label for="schedule-task-input">Task Title</label>
                        <input type="text" id="schedule-task-input" placeholder="e.g., Complete project proposal..." />
                    </div>
                    <div class="modal-form-group">
                        <label for="schedule-duration">Estimated Duration (minutes)</label>
                        <input type="number" id="schedule-duration" placeholder="30" min="5" max="480" value="30" />
                    </div>
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="submitScheduleTask()">Schedule It</button>
                    </div>
                </div>
            `;
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) closeScheduleModal();
            });
            document.body.appendChild(backdrop);
            return backdrop;
        }

        async function submitScheduleTask() {
            const title = document.getElementById('schedule-task-input').value.trim();
            const duration = parseInt(document.getElementById('schedule-duration').value) || 30;
            if (!title) {
                showFeedback('Please enter a task title', 'warning');
                return;
            }
            closeScheduleModal();
            try {
                showFeedback(`üìã "${title}" scheduled for your peak focus window!`);
                await loadSchedule();
            } catch (error) {
                console.error('Error scheduling task:', error);
                showFeedback('Failed to schedule task', 'warning');
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                const analytics = await response.json();
                appState.analytics = analytics;
                renderAnalytics();
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function renderAnalytics() {
            const a = appState.analytics || {};
            const deepEl = document.getElementById('deep-focus-score');
            const totalEl = document.getElementById('total-focus-time');
            const consEl = document.getElementById('consistency');
            const distEl = document.getElementById('distractions');

            if (deepEl) deepEl.textContent = (a.deep_focus_score ?? 0) + '%';
            if (totalEl) totalEl.textContent = a.total_focus_time || '0m';
            if (consEl) consEl.textContent = (a.consistency ?? 0) + '%';
            if (distEl) distEl.textContent = a.distractions ?? 0;

            // Try server-generated AI insight first (preferred)
            let usedServerInsight = false;
            try {
                const resp = await fetch('/api/ai_insight');
                if (resp.ok) {
                    const data = await resp.json();
                    const titleEl = document.getElementById('ai-insight-title');
                    const descEl = document.getElementById('ai-insight-desc');
                    if (titleEl && data.title) titleEl.textContent = data.title;
                    if (descEl && data.desc) {
                        descEl.innerHTML = data.desc;
                        descEl.dataset.dynamic = 'true';
                    }
                    usedServerInsight = true;
                }
            } catch (e) {
                // server insight failed; fall back to client-side heuristics below
            }

            // Derive a peak time if not provided
            let peakTime = a.peak_insight_time;
            try {
                if (!peakTime && Array.isArray(appState.focusHistory) && appState.focusHistory.length) {
                    const maxVal = Math.max(...appState.focusHistory);
                    const idx = appState.focusHistory.indexOf(maxVal);
                    // Map index to a friendly time-of-day bucket
                    const n = appState.focusHistory.length;
                    const part = idx < n/3 ? 'morning' : (idx < 2*n/3 ? 'afternoon' : 'evening');
                    peakTime = `around ${part}`;
                }
            } catch (e) {
                console.warn('Error computing peak time:', e);
            }

            if (peakTime) {
                const peakEl = document.getElementById('peak-insight-time');
                if (peakEl) peakEl.textContent = peakTime;
            }

            // Build a concise, actionable AI insight (client fallback if server unavailable)
            let title = 'AI Insight';
            let desc = '';

            const deepScore = a.deep_focus_score ?? null;
            const consistency = a.consistency ?? null;
            const distractions = a.distractions ?? null;

            // Human-friendly peak window
            let peakWindow = a.peak_insight_time || null;
            if (!peakWindow && peakTime) {
                if (peakTime.includes('morning')) peakWindow = '9:00 AM - 11:00 AM';
                else if (peakTime.includes('afternoon')) peakWindow = '1:00 PM - 3:00 PM';
                else if (peakTime.includes('evening')) peakWindow = '6:00 PM - 8:00 PM';
                else peakWindow = peakTime;
            }

            // Suggested task (first unfinished) or generic example
            let suggestedTask = null;
            try {
                if (Array.isArray(appState.tasks) && appState.tasks.length) {
                    const unfinished = appState.tasks.find(t => (t.completed ?? 0) < (t.total ?? 1));
                    if (unfinished) suggestedTask = unfinished.title;
                    else {
                        const mathTask = appState.tasks.find(t => /math/i.test(t.title));
                        if (mathTask) suggestedTask = mathTask.title;
                    }
                }
            } catch (e) { /* ignore */ }
            if (!suggestedTask) suggestedTask = 'challenging subjects (e.g., Math)';

            // Session length recommendation based on deep focus
            let sessionAdvice = 'Try 20‚Äì25 minute Pomodoro sessions to build momentum.';
            if (deepScore !== null) {
                if (deepScore >= 75) sessionAdvice = 'Schedule longer, uninterrupted sessions (60‚Äì90 minutes).';
                else if (deepScore >= 50) sessionAdvice = 'Aim for 45‚Äì60 minute focused sessions.';
            }

            // Compose description
            if (peakWindow) {
                desc += `Based on recent performance, your focus tends to peak around <strong>${peakWindow}</strong>. `;
            } else {
                desc += `Based on recent performance, we detected a recurring peak focus window. `;
            }
            desc += `We recommend scheduling your most challenging tasks ‚Äî like <em>${suggestedTask}</em> ‚Äî during that period. ${sessionAdvice} `;

            if (consistency !== null && consistency < 60) {
                desc += 'Your routine consistency is low; try a regular daily start time and limit context switching. ';
            }
            if (distractions !== null && distractions > 3) {
                desc += 'Reduce notifications and external interruptions during focused blocks to lower distractions.';
            }

            if (!usedServerInsight) {
                const titleEl = document.getElementById('ai-insight-title');
                const descEl = document.getElementById('ai-insight-desc');
                if (titleEl) titleEl.textContent = `${title}: ${peakWindow ? 'Peak Focus Window' : 'Personalized Tip'}`;
                if (descEl) {
                    descEl.innerHTML = desc;
                    descEl.dataset.dynamic = 'true';
                }
            }

            renderFocusChart();
            renderDistractionChart();
        }

        function renderFocusChart() {
            const ctx = document.getElementById('focus-chart');
            if (!ctx) return;

            if (window.focusChart) {
                window.focusChart.destroy();
            }

            window.focusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: appState.focusHistory.length}, (_, i) => `T${i+1}`),
                    datasets: [{
                        label: 'Focus Score',
                        data: appState.focusHistory,
                        borderColor: '#5ec4a9',
                        backgroundColor: 'rgba(94, 196, 169, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderDistractionChart() {
            const container = document.getElementById('distraction-chart');
            if (!container) return;

            const sources = appState.analytics.distraction_sources || {};
            const total = Object.values(sources).reduce((a, b) => a + b, 0);
            container.innerHTML = '';
            Object.entries(sources).forEach(([source, count]) => {
                const percentage = Math.round((count / total) * 100);
                const colors = {
                    'Phone': '#ef4444',
                    'Noise': '#f59e0b',
                    'Daydream': '#8b5cf6',
                    'Fidgeting': '#10b981'
                };
                const barHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>${source}</span>
                            <span style="font-weight: 600;">${percentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%; background: ${colors[source] || '#5ec4a9'};"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += barHTML;
            });
        }

        function showSettingsSection(section, evt) {
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const trigger = evt?.currentTarget || evt?.target;
            if (trigger) {
                trigger.classList.add('active');
            }
            const navMap = {
                'accessibility': 'accessibility-id',
                'buddy': 'focusbuddy-id',
                'privacy': 'privacy-id'
            };
            if (!trigger && navMap[section]) {
                const navItem = document.getElementById(navMap[section]);
                if (navItem) navItem.classList.add('active');
            }

            const sectionMap = {
                'accessibility': 'a&s-id',
                'buddy': 'fb-id',
                'privacy': 'ph-id'
            };
            const targetId = sectionMap[section];
            if (targetId) {
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const header = target.querySelector('h3');
                    if (header) {
                        header.setAttribute('tabindex', '-1');
                        header.focus();
                    }
                }
            }
        }

        async function toggleSetting(settingName) {
            appState.settings[settingName] = !appState.settings[settingName];
            const toggle = event.target;
            toggle.classList.toggle('active');

            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState.settings)
                });
            } catch (error) {
                console.error('Error saving settings:', error);
            }
            // If camera access was turned off, ensure camera is disabled immediately
            if (settingName === 'camera_access' && !appState.settings.camera_access) {
                try {
                    // If camera currently active, request server to turn it off
                    if (appState.cameraActive) {
                        const resp = await fetch('/api/toggle_camera', { method: 'POST' });
                        const d = await resp.json();
                        appState.cameraActive = d.camera_active;
                    }
                } catch (err) {
                    console.error('Error disabling camera after permission change:', err);
                }
            }
            applySettings();

            // Provide user feedback about the change
            const toggleMessages = {
                'dyslexia_font': ['Font changed to dyslexic friendly', 'Dyslexic font disabled'],
                'proactive_interventions': ['Proactive interventions enabled', 'Proactive interventions disabled'],
                'camera_access': ['Camera access enabled', 'Camera access disabled'],
                'dark_mode': ['Dark mode enabled', 'Light mode enabled'],
                'color_blind_mode': ['Color-blind mode enabled', 'Color-blind mode disabled'],
                'hide_sidebar': ['Sidebar hidden', 'Sidebar shown']
            };
            if (toggleMessages[settingName]) {
                const msg = appState.settings[settingName] ? toggleMessages[settingName][0] : toggleMessages[settingName][1];
                showFeedback(msg);
            }
        }

        async function updateSetting(settingName, value) {
    appState.settings[settingName] = value;

    try {
        await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appState.settings)
        });
    } catch (error) {
        console.error('Save error:', error);
    }

    applySettings();
    
    // If language changed, apply it
    if (settingName === 'language') {
        applyLanguage();
        showFeedback(`Language changed to ${value}`, 'success', 2500);
    }
    
    // Feedback for other settings
    const feedbackMessages = {
        'color_contrast': (v) => `Color contrast set to ${v}`,
        'buddy_persona': (v) => `Buddy persona set to ${v}`,
        'dark_mode': (v) => v ? 'Dark mode enabled' : 'Dark mode disabled',
        'dyslexia_font': (v) => v ? 'Dyslexia font enabled' : 'Dyslexia font disabled',
        'color_blind_mode': (v) => v ? 'Color blind mode enabled' : 'Color blind mode disabled',
        'hide_sidebar': (v) => v ? 'Sidebar hidden' : 'Sidebar shown',
        'proactive_interventions': (v) => v ? 'Proactive interventions enabled' : 'Proactive interventions disabled',
        'camera_access': (v) => v ? 'Camera access enabled' : 'Camera access disabled'
    };
    
    if (feedbackMessages[settingName]) {
        showFeedback(feedbackMessages[settingName](value));
    }
}

        function applySettings() {
                    // Dyslexia font
                    document.body.classList.toggle('dyslexia-font', appState.settings.dyslexia_font);

                    // Dark mode
                    document.body.classList.toggle('dark-mode', !!appState.settings.dark_mode);

                    // Color-blind mode
                    document.body.classList.toggle('color-blind', !!appState.settings.color_blind_mode);

                    // Hide/Show sidebar
                    const sidebarEl = document.querySelector('.sidebar');
                    if (sidebarEl) sidebarEl.classList.toggle('hidden', !!appState.settings.hide_sidebar);

                    // Contrast levels
                    document.body.classList.remove('high-contrast', 'maximum-contrast');
                    if (appState.settings.color_contrast === 'High') {
                        document.body.classList.add('high-contrast');
                    } else if (appState.settings.color_contrast === 'Maximum') {
                        document.body.classList.add('maximum-contrast');
                    }

                    // Sync toggle controls
                    const safeToggle = (id, val) => { const el = document.getElementById(id); if (el) el.classList.toggle('active', !!val); };
                    safeToggle('dyslexia-toggle', appState.settings.dyslexia_font);
                    safeToggle('intervention-toggle', appState.settings.proactive_interventions);
                    safeToggle('camera-access-toggle', appState.settings.camera_access);
                    safeToggle('darkmode-toggle', appState.settings.dark_mode);
                    safeToggle('colorblind-toggle', appState.settings.color_blind_mode);
                    safeToggle('sidebar-toggle', appState.settings.hide_sidebar);

                    // Sync selects
                    const cs = document.getElementById('contrast-select'); if (cs) cs.value = appState.settings.color_contrast || 'Standard';
                    const ps = document.getElementById('persona-select'); if (ps) ps.value = appState.settings.buddy_persona || 'Friendly Peer';
                    const ls = document.getElementById('language-select'); if (ls) ls.value = appState.settings.language || 'English';

                    applyLanguage();
        }

        function triggerBreak(activity) {
            const messages = {
                'jumping-jacks': "Great choice! Do 5 jumping jacks and come back energized!",
                'water': "Perfect! Stay hydrated. I'll be here when you get back!",
                'pet': "Aww, go give your cat some love! See you in a minute!",
                'stretch': "Good idea! Stretch those muscles. Your body will thank you!"
            };

            const message = messages[activity] || "Nice! Taking a quick break is smart. See you soon!";
            document.getElementById('buddy-message').textContent = message;
            speakMessage(message);
        }

        window.onload = init;
    </script>
</body>
</html>
